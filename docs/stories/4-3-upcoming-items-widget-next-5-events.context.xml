<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>3</storyId>
    <title>Upcoming Items Widget</title>
    <status>drafted</status>
    <generatedAt>2026-02-06</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-3-upcoming-items-widget-next-5-events.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>job seeker</asA>
    <iWant>see my next upcoming interviews and assessment deadlines on the dashboard</iWant>
    <soThat>I always know what's coming next without opening the timeline</soThat>
    <tasks>
      <task id="1" acs="3,5,6">Create Backend Upcoming Events Endpoint
        <subtask id="1.1">Create `GET /api/dashboard/upcoming` endpoint in `dashboard_handler.go`</subtask>
        <subtask id="1.2">Implement `GetUpcomingItems(userID int64, limit int) ([]UpcomingItem, error)` in dashboard repository</subtask>
        <subtask id="1.3">Query interviews (scheduled_date >= today) and assessments (due_date >= today, status != submitted)</subtask>
        <subtask id="1.4">Merge and sort by date ASC, limit to param (default 4)</subtask>
        <subtask id="1.5">Calculate countdown info (days_until, urgency level, display text)</subtask>
        <subtask id="1.6">Include overdue items at top (ordered by most overdue first)</subtask>
        <subtask id="1.7">Write unit tests for countdown calculation and urgency logic</subtask>
      </task>
      <task id="2" acs="3,4,5">Create UpcomingItem TypeScript Types and Service
        <subtask id="2.1">Create `frontend/src/types/upcoming.ts` with UpcomingItem and CountdownInfo types</subtask>
        <subtask id="2.2">Add `getUpcomingItems(limit?: number, type?: 'all' | 'interviews' | 'assessments')` to dashboard service</subtask>
        <subtask id="2.3">Define urgency type: 'overdue' | 'tomorrow' | 'soon' | 'normal'</subtask>
      </task>
      <task id="3" acs="1,2,4,8,10">Create UpcomingWidget Component
        <subtask id="3.1">Create `frontend/src/app/(app)/dashboard/components/UpcomingWidget.tsx`</subtask>
        <subtask id="3.2">Implement section header with "Upcoming" title (18px, font-weight 600)</subtask>
        <subtask id="3.3">Add filter chips row with "All", "Interviews", "Assessments" options</subtask>
        <subtask id="3.4">Style active chip: `$--primary` fill, `$--primary-foreground` text</subtask>
        <subtask id="3.5">Style inactive chips: transparent, `$--border` stroke, `$--muted-foreground` text</subtask>
        <subtask id="3.6">Add "View all" link aligned right that navigates to `/timeline`</subtask>
        <subtask id="3.7">Implement loading skeleton state</subtask>
        <subtask id="3.8">Implement empty state with encouraging message</subtask>
      </task>
      <task id="4" acs="4,5,6,7">Create UpcomingItemCard Component
        <subtask id="4.1">Create `frontend/src/app/(app)/dashboard/components/UpcomingItemCard.tsx`</subtask>
        <subtask id="4.2">Implement card structure: 16px padding, 8px corner radius, border color varies by urgency</subtask>
        <subtask id="4.3">Add icon wrapper (40x40px, 8px radius) with type-specific icon</subtask>
        <subtask id="4.4">Display info section: type badge + company name row, title (14px, font-weight 600), date (12px)</subtask>
        <subtask id="4.5">Add countdown badge with pill shape and urgency-specific colors</subtask>
        <subtask id="4.6">Implement urgency color mapping</subtask>
        <subtask id="4.7">Make entire card clickable with proper navigation link</subtask>
      </task>
      <task id="5" acs="1,9">Integrate Widget into Dashboard
        <subtask id="5.1">Add UpcomingWidget to dashboard page below stats row</subtask>
        <subtask id="5.2">Implement filter state and client-side filtering logic</subtask>
        <subtask id="5.3">Handle API errors with error state and retry</subtask>
        <subtask id="5.4">Verify layout responsiveness</subtask>
      </task>
      <task id="6" acs="7">Testing and Accessibility
        <subtask id="6.1">Verify keyboard navigation through filter chips and item cards</subtask>
        <subtask id="6.2">Add aria-labels to filter chips and countdown badges</subtask>
        <subtask id="6.3">Test screen reader announces urgency level via aria-label</subtask>
        <subtask id="6.4">Manual testing: filter switching, navigation, empty states, error states</subtask>
        <subtask id="6.5">Test with real data: interviews and assessments with various urgency levels</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Dashboard displays "Upcoming" widget with section header (18px, font-weight 600), filter chips, and item list</ac>
    <ac id="2">Filter chips displayed with 16px gap: "All" (active by default), "Interviews", "Assessments" - chips use pill shape (999 radius), padding 6/12</ac>
    <ac id="3">Shows 4 upcoming events (interviews + assessments) merged and sorted chronologically by date</ac>
    <ac id="4">Each event displays as a card with: icon wrapper (40x40px), type badge, company name, title, date, and countdown badge</ac>
    <ac id="5">4-level urgency color coding: Overdue (dark red #7f1d1d), Tomorrow (secondary), Soon (accent), Normal (border-border/muted)</ac>
    <ac id="6">Overdue items appear first with red highlighting and "Overdue" badge text</ac>
    <ac id="7">Clicking an event navigates to its detail page (/interviews/:id or /applications/:applicationId/assessments/:id)</ac>
    <ac id="8">Empty state displays encouraging message: "No upcoming events" with optional CTA</ac>
    <ac id="9">Filter selection updates the displayed list (client-side filtering of fetched data)</ac>
    <ac id="10">"View all" link navigates to timeline page</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Story 4.3: Upcoming Items Widget</section>
        <snippet>Detailed API contract for GET /api/dashboard/upcoming, urgency calculation logic, and design file references including frame IDs y2upp, YHrpm, ALk58, e9t81, x26IZ, 7nk4a, zLhhW, vJsvQ.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Ditto MVP Epics</title>
        <section>Epic 4 - Story 4.3</section>
        <snippet>Story definition with acceptance criteria for upcoming items widget displaying next 5 events (design shows 4) with urgency color coding and filter chips.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>API Contracts, Consistency Rules</section>
        <snippet>Dashboard endpoints pattern, date/time handling (ISO 8601), pagination, error response format. Dashboard load target &lt;2 seconds.</snippet>
      </doc>
      <doc>
        <path>docs/stories/4-2-dashboard-quick-actions.md</path>
        <title>Story 4.2: Dashboard Quick Actions</title>
        <section>Dev Agent Record</section>
        <snippet>Previous story established dashboard page structure, service pattern, error handling UI, and PageHeader with actions prop. ApplicationSelectorDialog pattern for dialogs.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/internal/handlers/dashboard_handler.go</path>
        <kind>handler</kind>
        <symbol>DashboardHandler.GetStats</symbol>
        <lines>23-33</lines>
        <reason>Existing dashboard handler pattern - extend with GetUpcomingItems handler</reason>
      </artifact>
      <artifact>
        <path>backend/internal/repository/dashboard_repository.go</path>
        <kind>repository</kind>
        <symbol>DashboardRepository</symbol>
        <lines>14-67</lines>
        <reason>Repository pattern with caching (5 min TTL) - extend with GetUpcomingItems method</reason>
      </artifact>
      <artifact>
        <path>backend/internal/routes/dashboard.go</path>
        <kind>routes</kind>
        <symbol>RegisterDashboardRoutes</symbol>
        <lines>11-19</lines>
        <reason>Route registration pattern - add /upcoming endpoint</reason>
      </artifact>
      <artifact>
        <path>frontend/src/app/(app)/page.tsx</path>
        <kind>page</kind>
        <symbol>Dashboard</symbol>
        <lines>1-175</lines>
        <reason>Dashboard page - add UpcomingWidget below stats row</reason>
      </artifact>
      <artifact>
        <path>frontend/src/services/dashboard-service.ts</path>
        <kind>service</kind>
        <symbol>getStats</symbol>
        <lines>18-21</lines>
        <reason>Service pattern - add getUpcomingItems function</reason>
      </artifact>
      <artifact>
        <path>frontend/src/components/stat-card/stat-card.tsx</path>
        <kind>component</kind>
        <symbol>StatCard</symbol>
        <lines>1-54</lines>
        <reason>Component structure reference for UpcomingItemCard (button, styling, click handler)</reason>
      </artifact>
      <artifact>
        <path>backend/internal/repository/interview.go</path>
        <kind>repository</kind>
        <symbol>InterviewRepository.GetInterviewByID</symbol>
        <lines>74-91</lines>
        <reason>Interview query pattern - use for upcoming interviews query</reason>
      </artifact>
      <artifact>
        <path>backend/internal/repository/assessment.go</path>
        <kind>repository</kind>
        <symbol>AssessmentWithContext</symbol>
        <lines>91-95</lines>
        <reason>Assessment with context pattern - model for upcoming items with company_name, job_title</reason>
      </artifact>
      <artifact>
        <path>backend/internal/models/interview.go</path>
        <kind>model</kind>
        <symbol>Interview</symbol>
        <lines>26-43</lines>
        <reason>Interview model with ScheduledDate field (time.Time) for upcoming query</reason>
      </artifact>
      <artifact>
        <path>backend/internal/models/assessment.go</path>
        <kind>model</kind>
        <symbol>Assessment</symbol>
        <lines>32-45</lines>
        <reason>Assessment model with DueDate (string), Status fields for upcoming query</reason>
      </artifact>
    </code>
    <dependencies>
      <frontend>
        <package name="next" version="14.2.15"/>
        <package name="react" version="^18"/>
        <package name="date-fns" version="^4.1.0"/>
        <package name="lucide-react" version="^0.452.0"/>
        <package name="axios" version="^1.7.9"/>
        <package name="tailwindcss" version="^4.1.10"/>
        <package name="@radix-ui/react-dialog" version="^1.1.2"/>
      </frontend>
      <backend>
        <package name="github.com/gin-gonic/gin" version="v1.10.1"/>
        <package name="github.com/jmoiron/sqlx" version="v1.4.0"/>
        <package name="github.com/google/uuid" version="v1.6.0"/>
        <package name="github.com/lib/pq" version="v1.10.9"/>
      </backend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Follow existing dashboard handler/repository pattern in backend/internal/handlers/dashboard_handler.go</constraint>
    <constraint>Use date-fns for frontend date calculations and formatting</constraint>
    <constraint>Dashboard must load within 2 seconds (NFR-1.1)</constraint>
    <constraint>API response should be &lt;500ms</constraint>
    <constraint>Use ISO 8601 date format for API responses</constraint>
    <constraint>Follow existing component structure: export from component folder with index.ts barrel</constraint>
    <constraint>Use shadcn/ui button, badge components for consistent styling</constraint>
    <constraint>All queries must filter by user_id for authorization</constraint>
    <constraint>Use soft delete pattern (deleted_at IS NULL) in queries</constraint>
    <constraint>Limit to 4 items as per design file (not 5 as in original spec)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/dashboard/upcoming</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/dashboard/upcoming?limit=4&amp;type=all|interviews|assessments</signature>
      <path>backend/internal/routes/dashboard.go</path>
    </interface>
    <interface>
      <name>UpcomingItem</name>
      <kind>Go struct</kind>
      <signature>type UpcomingItem struct { ID uuid.UUID; Type string; Title string; CompanyName string; JobTitle string; DueDate time.Time; Countdown CountdownInfo; Link string }</signature>
      <path>backend/internal/repository/dashboard_repository.go</path>
    </interface>
    <interface>
      <name>CountdownInfo</name>
      <kind>Go struct</kind>
      <signature>type CountdownInfo struct { Text string; Urgency string; DaysUntil int }</signature>
      <path>backend/internal/repository/dashboard_repository.go</path>
    </interface>
    <interface>
      <name>getUpcomingItems</name>
      <kind>TypeScript function</kind>
      <signature>export async function getUpcomingItems(limit?: number, type?: 'all' | 'interviews' | 'assessments'): Promise&lt;UpcomingItem[]&gt;</signature>
      <path>frontend/src/services/dashboard-service.ts</path>
    </interface>
    <interface>
      <name>UpcomingWidgetProps</name>
      <kind>React component props</kind>
      <signature>interface UpcomingWidgetProps { items: UpcomingItem[]; loading: boolean; error?: string; onFilterChange: (filter: string) =&gt; void; onRetry: () =&gt; void }</signature>
      <path>frontend/src/app/(app)/dashboard/components/UpcomingWidget.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Project uses unit tests for repository layer and integration tests for handlers. Backend tests use testify for assertions and testutil package for database fixtures. Frontend testing is manual per current project pattern. Focus on urgency calculation logic correctness and edge cases (overdue, today, various days until).</standards>
    <locations>
      <location>backend/internal/repository/*_test.go</location>
      <location>backend/internal/handlers/*_test.go</location>
    </locations>
    <ideas>
      <idea ac="3,5,6">Test urgency calculation: overdue (-1 day), today (0), tomorrow (1), soon (2-3), normal (4+)</idea>
      <idea ac="3,6">Test sorting: overdue items first (most overdue first), then by date ASC</idea>
      <idea ac="3">Test limit parameter respects value (default 4, custom values)</idea>
      <idea ac="3">Test merge logic: interviews and assessments combined correctly</idea>
      <idea ac="3">Test filter by type: all, interviews only, assessments only</idea>
      <idea ac="7">Test navigation links: correct URL format for interviews and assessments</idea>
      <idea ac="8">Test empty state: no upcoming items returns empty array</idea>
    </ideas>
  </tests>
</story-context>
