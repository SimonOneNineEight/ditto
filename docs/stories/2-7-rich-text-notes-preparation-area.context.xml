<story-context id="2-7-rich-text-notes-preparation-area" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>7</storyId>
    <title>Rich Text Notes - Preparation Area</title>
    <status>drafted</status>
    <generatedAt>2026-01-27</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-7-rich-text-notes-preparation-area.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>job seeker</asA>
    <iWant>a flexible rich text area to write company research, practice answers, and general preparation notes</iWant>
    <soThat>I can keep all my prep materials in one place without rigid structure</soThat>
    <tasks>
      <task id="1" title="Create Note Handler" acs="7,8">
        <subtask>1.1: Create backend/internal/handlers/interview_note.go</subtask>
        <subtask>1.2: Implement CreateOrUpdateNote handler for POST /api/interviews/:id/notes</subtask>
        <subtask>1.3: Validate note_type is valid enum (preparation, company_research, feedback, reflection, general)</subtask>
        <subtask>1.4: Validate interview exists and belongs to user</subtask>
        <subtask>1.5: Implement upsert logic (create if not exists, update if exists for same note_type)</subtask>
      </task>
      <task id="2" title="Markdown Validation Service" acs="5,7">
        <subtask>2.1: Create backend/internal/services/markdown_service.go</subtask>
        <subtask>2.2: Validate content is plain text/markdown (reject raw HTML tags)</subtask>
        <subtask>2.3: Enforce 50KB max content size</subtask>
        <subtask>2.4: Optionally normalize markdown (trim whitespace, consistent line endings)</subtask>
      </task>
      <task id="3" title="Note Repository" acs="7,8">
        <subtask>3.1: Create backend/internal/repository/interview_note.go (if not exists)</subtask>
        <subtask>3.2: Implement CreateInterviewNote, UpdateInterviewNote, GetNoteByInterviewAndType</subtask>
        <subtask>3.3: Implement GetNotesByInterview for loading all notes</subtask>
      </task>
      <task id="4" title="Register Note Routes" acs="7">
        <subtask>4.1: Create backend/internal/routes/interview_note.go</subtask>
        <subtask>4.2: Register route: POST /api/interviews/:id/notes</subtask>
        <subtask>4.3: Apply auth middleware</subtask>
      </task>
      <task id="5" title="Install TipTap and Markdown Dependencies" acs="2">
        <subtask>5.1: Install @tiptap/react, @tiptap/starter-kit, @tiptap/extension-link, @tiptap/extension-placeholder, @tiptap/extension-underline</subtask>
        <subtask>5.2: Install @tiptap/pm for markdown serialization (prosemirror-markdown)</subtask>
        <subtask>5.3: Install react-markdown + remark-gfm for rendering markdown in preview mode</subtask>
        <subtask>5.4: Create TypeScript types for TipTap if needed</subtask>
      </task>
      <task id="6" title="Create RichTextEditor Component" acs="2,3,4">
        <subtask>6.1: Create frontend/src/components/shared/rich-text-editor.tsx</subtask>
        <subtask>6.2: Initialize TipTap with StarterKit, Link, Underline, Placeholder extensions</subtask>
        <subtask>6.3: Enable markdown input shortcuts (StarterKit default: **bold**, ## heading, - list)</subtask>
        <subtask>6.4: Create formatting toolbar with shadcn/ui Toggle buttons</subtask>
        <subtask>6.5: Implement keyboard shortcuts (Ctrl+B, Ctrl+I, Ctrl+U)</subtask>
        <subtask>6.6: Add link dialog for URL input</subtask>
        <subtask>6.7: Convert pasted HTML content to markdown-compatible format</subtask>
        <subtask>6.8: Accept value (markdown), onChange (returns markdown), placeholder props</subtask>
        <subtask>6.9: Implement markdown serialization on output using prosemirror-markdown</subtask>
      </task>
      <task id="7" title="Create useAutoSave Hook Enhancement" acs="6">
        <subtask>7.1: Create/enhance frontend/src/lib/hooks/useAutoSave.ts</subtask>
        <subtask>7.2: Implement 30-second debounce timer</subtask>
        <subtask>7.3: Track save status: idle | saving | saved | error</subtask>
        <subtask>7.4: Support retry on error</subtask>
        <subtask>7.5: Only save if content changed since last save (hash comparison)</subtask>
      </task>
      <task id="8" title="Update Interview Service" acs="7,8">
        <subtask>8.1: Add createOrUpdateNote(interviewId, noteType, content) function</subtask>
        <subtask>8.2: Handle validation errors from backend</subtask>
      </task>
      <task id="9" title="Create NotesSection Component" acs="1,7,8">
        <subtask>9.1: Create frontend/src/components/interview-detail/notes-section.tsx</subtask>
        <subtask>9.2: Display note types as collapsible sections (Preparation, Company Research, Feedback, Reflection, General)</subtask>
        <subtask>9.3: Show preview text or placeholder for each note type</subtask>
        <subtask>9.4: Integrate RichTextEditor when section is expanded/editing</subtask>
        <subtask>9.5: Integrate useAutoSave hook with 30s debounce</subtask>
        <subtask>9.6: Show auto-save status indicator (Saving..., Saved, Save failed - Retry)</subtask>
        <subtask>9.7: Call onUpdate callback after successful save</subtask>
      </task>
      <task id="10" title="Integrate NotesSection into Interview Detail Page" acs="1,7">
        <subtask>10.1: Add NotesSection to interview detail page</subtask>
        <subtask>10.2: Pass notes data and onUpdate callback</subtask>
        <subtask>10.3: Load notes from getInterviewWithDetails response</subtask>
      </task>
      <task id="11" title="Manual Testing" acs="all">
        <subtask>11.1: Test rich text formatting via toolbar (bold, italic, lists, headings)</subtask>
        <subtask>11.2: Test markdown input shortcuts (**bold**, ## heading, - list)</subtask>
        <subtask>11.3: Test link insertion and clicking</subtask>
        <subtask>11.4: Test paste from Word/Google Docs (converts to markdown)</subtask>
        <subtask>11.5: Test 30-second auto-save triggers</subtask>
        <subtask>11.6: Test save status indicators</subtask>
        <subtask>11.7: Test multiple note types (one per type)</subtask>
        <subtask>11.8: Test raw HTML rejection (paste script tags → stripped)</subtask>
        <subtask>11.9: Test content size limit (50KB)</subtask>
        <subtask>11.10: Test error handling on save failure</subtask>
        <subtask>11.11: Test markdown preview rendering</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" title="Notes Section Display">
      <when>the page loads</when>
      <then>I see a "Notes" section with expandable note types: Preparation, Company Research, Feedback, Reflection, General</then>
      <and>each note type shows a preview or "Add notes..." placeholder if empty</and>
    </criterion>
    <criterion id="AC-2" title="Rich Text Editor with Markdown Support">
      <when>I click on a note section to edit</when>
      <then>a rich text editor opens with formatting toolbar: bold, italic, underline, strikethrough, bullet list, numbered list, headings (H1-H3), links, blockquote</then>
      <and>the editor supports keyboard shortcuts (Ctrl+B for bold, Ctrl+I for italic, etc.)</and>
      <and>the editor supports markdown input shortcuts (typing **text** converts to bold, ## converts to H2, - creates bullet list, etc.)</and>
    </criterion>
    <criterion id="AC-3" title="Formatting Functionality">
      <when>I select text and click a formatting button</when>
      <then>the selected text is formatted accordingly</then>
      <and>formatting is visible immediately in the editor</and>
      <and>I can toggle formatting off by clicking the button again</and>
    </criterion>
    <criterion id="AC-4" title="Link Support">
      <when>I click the link button</when>
      <then>a dialog appears to enter URL</then>
      <and>the selected text becomes a clickable link</and>
      <and>links open in a new tab when clicked</and>
    </criterion>
    <criterion id="AC-5" title="Paste from External Sources">
      <when>I paste content from Word, Google Docs, or websites</when>
      <then>basic formatting is preserved (bold, italic, lists) and converted to markdown</then>
      <and>unsafe content (scripts, styles) is stripped during conversion</and>
      <and>excessive formatting is cleaned up to clean markdown</and>
    </criterion>
    <criterion id="AC-6" title="Auto-Save with 30-Second Debounce">
      <when>I stop typing for 30 seconds</when>
      <then>content auto-saves with visual "Saving..." indicator</then>
      <and>after save completes, indicator shows "Saved" with timestamp</and>
      <and>if save fails, indicator shows "Save failed - Retry" with retry button</and>
    </criterion>
    <criterion id="AC-7" title="Save/Update Note">
      <when>I click "Save" or trigger auto-save</when>
      <then>the note content is saved to the database as markdown</then>
      <and>I see a success toast notification</and>
      <and>the note appears in the interview detail with formatted preview (markdown rendered)</and>
    </criterion>
    <criterion id="AC-8" title="Multiple Note Types">
      <when>I add notes to different sections (Preparation, Feedback, etc.)</when>
      <then>each note type is stored separately</then>
      <and>I can have one note per type per interview</and>
      <and>all notes are loaded when viewing interview details</and>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/design-system-principles.md" title="Ditto Design System Principles" section="Design Philosophy, Components">
        <snippet>Dark theme first, 80% Notion-like aesthetic, calm and focused. Inputs should look like plain text until focused. Ghost buttons appear on hover. Use collapsible patterns for progressive disclosure.</snippet>
      </doc>
      <doc path="docs/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Note Entity, Note Endpoints, Services">
        <snippet>interview_notes table with note_type enum (preparation, company_research, feedback, reflection, general). POST /api/interviews/:id/notes for upsert. TipTap 3.0+ for rich text, auto-save with 30s debounce. Store as markdown (modified from original HTML spec).</snippet>
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Technology Stack, Implementation Patterns">
        <snippet>TipTap 3.0+ for rich text editing. Auto-save pattern with 30s debounce using useRef for timer. Follow existing handler/repository patterns. Use soft deletes with deleted_at column.</snippet>
      </doc>
      <doc path="docs/epics.md" title="Epic Definitions" section="Epic 2 Story 2.7">
        <snippet>Rich Text Notes - Preparation Area: TipTap editor with formatting toolbar, auto-save, multiple note types per interview for comprehensive preparation tracking.</snippet>
      </doc>
    </docs>

    <code>
      <artifact path="backend/internal/handlers/interview_question.go" kind="handler" symbol="InterviewQuestionHandler" reason="Reference pattern for note handler: ownership validation through interview → user chain, unified request handling for single/bulk operations">
        <lines>32-126</lines>
      </artifact>
      <artifact path="backend/internal/repository/interview_question.go" kind="repository" symbol="InterviewQuestionRepository" reason="Reference pattern for note repository: CRUD operations with soft delete, order management">
        <lines>all</lines>
      </artifact>
      <artifact path="backend/internal/routes/interview_question.go" kind="routes" symbol="RegisterInterviewQuestionRoutes" reason="Reference pattern for note route registration with auth middleware">
        <lines>all</lines>
      </artifact>
      <artifact path="frontend/src/components/interview-detail/questions-section.tsx" kind="component" symbol="QuestionsSection" reason="Reference pattern for auto-save: useCallback + useRef for 30s debounce timer, lastSavedRef for change detection, autoSaveStatus state">
        <lines>50-131</lines>
      </artifact>
      <artifact path="frontend/src/components/interview-detail/collapsible-section.tsx" kind="component" symbol="CollapsibleSection" reason="Reusable component for note type collapsible sections">
        <lines>all</lines>
      </artifact>
      <artifact path="frontend/src/services/interview-service.ts" kind="service" symbol="InterviewNote, interviewService" reason="Existing InterviewNote type defined, need to add createOrUpdateNote function">
        <lines>96-109</lines>
      </artifact>
      <artifact path="backend/internal/models/interview.go" kind="model" symbol="InterviewNote" reason="Check if InterviewNote model exists, may need to add/modify">
        <lines>all</lines>
      </artifact>
    </code>

    <dependencies>
      <backend name="Go">
        <package name="github.com/gin-gonic/gin" version="v1.10.1" />
        <package name="github.com/google/uuid" version="v1.6.0" />
        <package name="github.com/jmoiron/sqlx" version="v1.4.0" />
        <package name="github.com/microcosm-cc/bluemonday" version="v1.0.27" note="Available but may not be needed if storing markdown" />
      </backend>
      <frontend name="Node.js/npm">
        <package name="react" version="^18" />
        <package name="next" version="14.2.15" />
        <package name="@radix-ui/react-collapsible" version="^1.1.11" />
        <package name="sonner" version="^2.0.7" note="Toast notifications" />
        <package name="lucide-react" version="^0.452.0" note="Icons" />
        <!-- NEW DEPENDENCIES TO ADD -->
        <package name="@tiptap/react" version="^3.0.0" note="NEW - TipTap editor core" />
        <package name="@tiptap/starter-kit" version="^3.0.0" note="NEW - Basic formatting extensions" />
        <package name="@tiptap/extension-link" version="^3.0.0" note="NEW - Link support" />
        <package name="@tiptap/extension-placeholder" version="^3.0.0" note="NEW - Placeholder text" />
        <package name="@tiptap/extension-underline" version="^3.0.0" note="NEW - Underline formatting" />
        <package name="@tiptap/pm" version="^3.0.0" note="NEW - ProseMirror for markdown serialization" />
        <package name="react-markdown" version="^9.0.0" note="NEW - Markdown rendering" />
        <package name="remark-gfm" version="^4.0.0" note="NEW - GitHub flavored markdown support" />
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="tech-spec-epic-2.md">Use TipTap 3.0+ for rich text editing (headless, customizable, shadcn/ui compatible)</constraint>
    <constraint source="story">Store content as markdown (max 50KB per note) - inherently safer than HTML</constraint>
    <constraint source="story">Backend validates markdown (rejects raw HTML tags, enforces size limit)</constraint>
    <constraint source="tech-spec-epic-2.md">Auto-save with 30s debounce per PRD requirement</constraint>
    <constraint source="tech-spec-epic-2.md">Note types enum: preparation, company_research, feedback, reflection, general</constraint>
    <constraint source="architecture.md">Follow existing repository pattern (consistent with Epic 1)</constraint>
    <constraint source="architecture.md">Use existing auth middleware (JWT validation)</constraint>
    <constraint source="architecture.md">Use existing error format: {error, code, details}</constraint>
    <constraint source="architecture.md">Implement soft deletes (deleted_at column)</constraint>
    <constraint source="design-system-principles.md">Dark theme first, Notion-like aesthetic, progressive disclosure</constraint>
    <constraint source="design-system-principles.md">Ghost buttons appear on hover, borders appear on interaction</constraint>
    <constraint source="story">Database table interview_notes already exists (migration 000005)</constraint>
    <constraint source="story">Unique constraint on (interview_id, note_type) - one note per type per interview</constraint>
  </constraints>

  <interfaces>
    <interface name="POST /api/interviews/:id/notes" kind="REST endpoint">
      <signature>POST /api/interviews/:id/notes { note_type: string, content: string } → InterviewNoteResponse</signature>
      <path>backend/internal/handlers/interview_note.go (to be created)</path>
    </interface>
    <interface name="InterviewNote" kind="TypeScript interface">
      <signature>{ id: string, interview_id: string, note_type: string, content?: string, created_at: string, updated_at: string }</signature>
      <path>frontend/src/services/interview-service.ts:96-103</path>
    </interface>
    <interface name="createOrUpdateNote" kind="function signature">
      <signature>(interviewId: string, noteType: NoteType, content: string) => Promise&lt;InterviewNote&gt;</signature>
      <path>frontend/src/services/interview-service.ts (to be added)</path>
    </interface>
    <interface name="RichTextEditorProps" kind="TypeScript interface">
      <signature>{ value: string, onChange: (markdown: string) => void, placeholder?: string, disabled?: boolean }</signature>
      <path>frontend/src/components/shared/rich-text-editor.tsx (to be created)</path>
    </interface>
    <interface name="useAutoSave" kind="React hook">
      <signature>&lt;T&gt;(data: T, saveFunction: (data: T) => Promise&lt;void&gt;, options?: { debounceMs: number }) => { saveStatus: 'idle' | 'saving' | 'saved' | 'error', retry: () => void }</signature>
      <path>frontend/src/lib/hooks/useAutoSave.ts (to be created)</path>
    </interface>
    <interface name="NotesSectionProps" kind="TypeScript interface">
      <signature>{ notes: InterviewNote[], interviewId: string, onUpdate: () => void }</signature>
      <path>frontend/src/components/interview-detail/notes-section.tsx (to be created)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend tests use Go testing framework with testify assertions. Frontend uses manual testing for MVP (no automated component tests yet). Follow existing test patterns in backend/internal/handlers/*_test.go if present. Integration tests verify API endpoints work correctly with authentication.
    </standards>
    <locations>
      <location>backend/internal/handlers/*_test.go</location>
      <location>backend/internal/repository/*_test.go</location>
      <location>Manual browser testing for frontend components</location>
    </locations>
    <ideas>
      <idea ac="AC-1">Verify notes section renders with all 5 note types as collapsible sections</idea>
      <idea ac="AC-2">Test TipTap editor initializes with formatting toolbar, verify markdown shortcuts work</idea>
      <idea ac="AC-3">Click bold button, verify text is bolded; click again, verify toggle off</idea>
      <idea ac="AC-4">Insert link via dialog, verify link renders and opens in new tab</idea>
      <idea ac="AC-5">Paste HTML from clipboard, verify it converts to clean markdown, script tags stripped</idea>
      <idea ac="AC-6">Type in editor, wait 30s, verify auto-save triggers with Saving indicator</idea>
      <idea ac="AC-7">Backend test: POST /api/interviews/:id/notes creates/updates note, verify markdown stored</idea>
      <idea ac="AC-7">Backend test: Reject content > 50KB with appropriate error</idea>
      <idea ac="AC-8">Create notes for different types, verify each stored separately, load all on detail view</idea>
      <idea ac="backend">Test upsert logic: create new note, update existing note for same type</idea>
      <idea ac="backend">Test ownership validation: cannot create note for another user's interview</idea>
      <idea ac="backend">Test markdown validation: reject raw HTML tags like &lt;script&gt;</idea>
    </ideas>
  </tests>
</story-context>
