<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>2</storyId>
    <title>Global Search UI with Grouped Results</title>
    <status>drafted</status>
    <generatedAt>2026-02-09</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/5-2-global-search-ui-with-grouped-results.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a job seeker with growing data</asA>
    <iWant>to search across all my data from one search bar</iWant>
    <soThat>I can quickly find applications, interviews, or notes without remembering where I stored them</soThat>
    <tasks>
      <task id="1" title="Create Search Types and Service" acs="2,3,4">
        <subtask>1.1 Create frontend/src/types/search.ts with SearchResult and GroupedSearchResponse types</subtask>
        <subtask>1.2 Create frontend/src/services/searchService.ts with search method calling GET /api/search</subtask>
        <subtask>1.3 Add proper error handling and empty response handling</subtask>
      </task>
      <task id="2" title="Build GlobalSearch Component" acs="1,2,3,4,5,6,7">
        <subtask>2.1 Create frontend/src/components/shared/GlobalSearch/GlobalSearch.tsx</subtask>
        <subtask>2.2 Use shadcn/ui Command component (CommandDialog, CommandInput, CommandList, CommandGroup, CommandItem)</subtask>
        <subtask>2.3 Implement search input with 300ms debounce</subtask>
        <subtask>2.4 Add minimum 3 character validation before triggering search</subtask>
        <subtask>2.5 Show loading state while search is in progress</subtask>
        <subtask>2.6 Display grouped results with section headers</subtask>
        <subtask>2.7 Render each result with title, snippet (DOMPurify sanitized), and date</subtask>
        <subtask>2.8 Implement keyboard navigation via Command component</subtask>
        <subtask>2.9 Add empty state message for no results</subtask>
        <subtask>2.10 Handle click/Enter to navigate to detail page</subtask>
      </task>
      <task id="3" title="Integrate GlobalSearch into Sidebar" acs="1">
        <subtask>3.1 Add GlobalSearch trigger to sidebar (above navigation menu)</subtask>
        <subtask>3.2 Add keyboard shortcut trigger (Cmd/Ctrl + K)</subtask>
        <subtask>3.3 Style search button to match existing sidebar design</subtask>
        <subtask>3.4 Ensure responsive behavior on mobile</subtask>
      </task>
      <task id="4" title="Implement Snippet Rendering with Sanitization" acs="4">
        <subtask>4.1 Install DOMPurify: pnpm add dompurify @types/dompurify</subtask>
        <subtask>4.2 Create sanitizer utility in frontend/src/lib/sanitizer.ts</subtask>
        <subtask>4.3 Sanitize snippet HTML before rendering</subtask>
        <subtask>4.4 Style highlighted text (bold tags from ts_headline)</subtask>
      </task>
      <task id="5" title="Testing and Edge Cases" acs="2,5,6">
        <subtask>5.1-5.7 Manual testing for all acceptance criteria</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Search bar accessible from navbar on all pages - Global search input visible in navigation header across all authenticated routes</criterion>
    <criterion id="2">After 3+ characters, results appear within 1 second - Debounced input (300ms) triggers API call, results displayed quickly</criterion>
    <criterion id="3">Results grouped by type: Applications, Interviews, Assessments, Notes - Grouped sections with headers in dropdown/popover</criterion>
    <criterion id="4">Each result shows: title/company, snippet of matching text, last updated date - Match highlighting preserved from backend snippets</criterion>
    <criterion id="5">Clicking result navigates to detail page - Applications → /applications/:id, Interviews → /interviews/:id, Assessments → /assessments/:id, Notes → Interview detail page</criterion>
    <criterion id="6">If no results: "No results found for '{query}'. Try different keywords." - Empty state with helpful message</criterion>
    <criterion id="7">Keyboard navigation: arrow keys to navigate, Enter to select - Full keyboard accessibility using Command component</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-5.md" relevance="high">
        Epic 5 technical specification with search UI requirements, TypeScript types, API contracts, and workflow details.
        Key sections: Story 5.2 AC, Data Models (SearchResult, GroupedSearchResponse), Workflows and Sequencing (Search Flow).
      </doc>
      <doc path="docs/architecture.md" relevance="medium">
        ADR-002: HTML sanitization - Use DOMPurify on frontend for user-generated content display.
        ADR-003: PostgreSQL Full-Text Search for MVP scale.
        Component patterns and service patterns.
      </doc>
      <doc path="docs/epics.md" relevance="low">
        Story 5.2 acceptance criteria from epic definition.
      </doc>
    </docs>
    <code>
      <file path="backend/internal/models/search.go" relevance="high">
        Backend SearchResult and GroupedSearchResponse types - must match frontend types:
        - SearchResult: ID (uuid.UUID), Type, Title, Snippet, CompanyName, Rank, Link, UpdatedAt
        - GroupedSearchResponse: Applications[], Interviews[], Assessments[], Notes[], TotalCount, Query
      </file>
      <file path="backend/internal/handlers/search_handler.go" relevance="high">
        Search API implementation: GET /api/search?q={query}&amp;limit={limit}
        - Returns empty response for queries &lt;3 characters
        - Default limit 10, max 50
        - Requires authentication (user_id from context)
      </file>
      <file path="frontend/src/components/ui/command.tsx" relevance="high">
        shadcn/ui Command component already installed and configured.
        Exports: Command, CommandDialog, CommandInput, CommandList, CommandEmpty, CommandGroup, CommandItem, CommandShortcut, CommandSeparator.
        Uses cmdk library and Radix Dialog.
      </file>
      <file path="frontend/src/components/sidebar/sidebar.tsx" relevance="high">
        Main sidebar component - GlobalSearch trigger should be added here, above the navigation menu.
        Uses SidebarHeader, SidebarContent, SidebarFooter pattern.
        Search button should be added in SidebarHeader after the logo.
      </file>
      <file path="frontend/src/services/application-service.ts" relevance="medium">
        Example service pattern to follow:
        - Import api from @/lib/axios
        - Define TypeScript interfaces matching backend
        - Export async functions that call api.get() and return response.data?.data
      </file>
      <file path="frontend/src/lib/axios.ts" relevance="medium">
        Axios instance with authentication interceptor - use this for API calls.
        Automatically adds Bearer token from session.
      </file>
    </code>
    <dependencies>
      <package name="dompurify" version="latest" install="pnpm add dompurify @types/dompurify">
        HTML sanitization library for safely rendering search snippets with &lt;b&gt; highlight tags.
        Required per ADR-002 in architecture.md.
      </package>
      <package name="cmdk" version="existing" install="already installed">
        Command menu primitive used by shadcn/ui Command component.
      </package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="security">
      Snippets from backend contain HTML (&lt;b&gt; tags from ts_headline). Must sanitize with DOMPurify before rendering.
      Only allow safe tags (b, strong, em, i) in sanitized output.
    </constraint>
    <constraint type="performance">
      Debounce search input by 300ms to avoid excessive API calls.
      Results should appear within 1 second of query submission (NFR-1.4).
    </constraint>
    <constraint type="accessibility">
      Use Command component for built-in keyboard navigation (arrow keys, Enter, Escape).
      Search dialog should trap focus and be dismissible with Escape key.
    </constraint>
    <constraint type="ux">
      Minimum 3 characters required before search triggers (match backend validation).
      Show loading state during API call to indicate search in progress.
    </constraint>
  </constraints>

  <interfaces>
    <api endpoint="GET /api/search" method="GET">
      <params>
        <param name="q" type="string" required="true">Search query (min 3 chars)</param>
        <param name="limit" type="number" required="false">Max results per type (default 10, max 50)</param>
      </params>
      <response>
        {
          "applications": SearchResult[],
          "interviews": SearchResult[],
          "assessments": SearchResult[],
          "notes": SearchResult[],
          "total_count": number,
          "query": string
        }
      </response>
    </api>
    <navigation>
      <route type="application" pattern="/applications/:id">Detail page for application results</route>
      <route type="interview" pattern="/interviews/:id">Detail page for interview results</route>
      <route type="assessment" pattern="/assessments/:id">Detail page for assessment results</route>
      <route type="note" pattern="/interviews/:interviewId">Notes link to parent interview detail page</route>
    </navigation>
  </interfaces>

  <tests>
    <standards>
      Manual testing for all acceptance criteria.
      Verify debounce behavior, keyboard navigation, and empty states.
    </standards>
    <locations>
      frontend/src/components/shared/GlobalSearch/__tests__/ (if unit tests added)
    </locations>
    <ideas>
      <test>Verify search does not trigger with &lt;3 characters</test>
      <test>Verify debounce delays API call by 300ms</test>
      <test>Verify grouped results display correctly with section headers</test>
      <test>Verify Cmd/Ctrl+K opens search dialog</test>
      <test>Verify arrow key navigation selects different results</test>
      <test>Verify Enter navigates to correct detail page</test>
      <test>Verify Escape closes search dialog</test>
      <test>Verify empty state message shows for no results</test>
      <test>Verify HTML snippets are sanitized (no XSS)</test>
      <test>Verify bold highlights render correctly in snippets</test>
    </ideas>
  </tests>
</story-context>
