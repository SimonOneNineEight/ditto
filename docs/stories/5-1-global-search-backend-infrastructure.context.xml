<story-context id="5-1-global-search-backend-infrastructure" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>1</storyId>
    <title>Global Search Backend Infrastructure</title>
    <status>ready-for-dev</status>
    <generatedAt>2026-02-09</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/5-1-global-search-backend-infrastructure.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>job seeker with many applications</asA>
    <iWant>to search across all my data using keywords</iWant>
    <soThat>I can quickly find any application, interview, or note regardless of how much data I have</soThat>
    <tasks>
      <task id="1" ac="1,3">Create Migration for Search Infrastructure
        <subtask id="1.1">Create migration 000010_add_search_vectors.up.sql</subtask>
        <subtask id="1.2">Add search_vector tsvector column to applications table</subtask>
        <subtask id="1.3">Add search_vector tsvector column to interview_notes table</subtask>
        <subtask id="1.4">Add search_vector tsvector column to interview_questions table</subtask>
        <subtask id="1.5">Add search_vector tsvector column to assessments table</subtask>
        <subtask id="1.6">Create GIN indexes on all search_vector columns</subtask>
        <subtask id="1.7">Create trigger functions to auto-update search vectors on INSERT/UPDATE</subtask>
        <subtask id="1.8">Backfill existing data with computed search vectors</subtask>
        <subtask id="1.9">Create corresponding down migration</subtask>
      </task>
      <task id="2" ac="2,6">Create Search Models
        <subtask id="2.1">Create backend/internal/models/search.go</subtask>
        <subtask id="2.2">Define SearchResult struct with ID, Type, Title, Snippet, CompanyName, Rank, Link, UpdatedAt</subtask>
        <subtask id="2.3">Define GroupedSearchResponse struct with arrays per type, TotalCount, Query</subtask>
      </task>
      <task id="3" ac="2,3,4,6">Create Search Repository
        <subtask id="3.1">Create backend/internal/repository/search_repository.go</subtask>
        <subtask id="3.2">Implement SearchApplications method using websearch_to_tsquery</subtask>
        <subtask id="3.3">Implement SearchInterviews method</subtask>
        <subtask id="3.4">Implement SearchAssessments method</subtask>
        <subtask id="3.5">Implement SearchNotes method for interview_questions and interview_notes</subtask>
        <subtask id="3.6">Use ts_rank for relevance scoring</subtask>
        <subtask id="3.7">Use ts_headline for generating snippets</subtask>
        <subtask id="3.8">Filter all queries by user_id for security</subtask>
      </task>
      <task id="4" ac="2,5,6">Create Search Handler
        <subtask id="4.1">Create backend/internal/handlers/search_handler.go</subtask>
        <subtask id="4.2">Implement GetSearch handler accepting q and limit params</subtask>
        <subtask id="4.3">Validate minimum query length (3 characters)</subtask>
        <subtask id="4.4">Default limit to 10 per type, max 50</subtask>
        <subtask id="4.5">Call repository methods and combine into GroupedSearchResponse</subtask>
        <subtask id="4.6">Return empty grouped response for short/empty queries</subtask>
      </task>
      <task id="5" ac="2">Register Search Routes
        <subtask id="5.1">Create backend/internal/routes/search.go</subtask>
        <subtask id="5.2">Register GET /api/search endpoint with auth middleware</subtask>
        <subtask id="5.3">Update main.go to register search routes</subtask>
      </task>
      <task id="6" ac="1,3">Run and Verify Migration
        <subtask id="6.1">Run migration against development database</subtask>
        <subtask id="6.2">Verify indexes created with \d applications, etc.</subtask>
        <subtask id="6.3">Verify triggers created and test INSERT/UPDATE</subtask>
      </task>
      <task id="7" ac="4,5,7">Testing and Performance Validation
        <subtask id="7.1">Manual test: search with 3+ characters returns results</subtask>
        <subtask id="7.2">Manual test: search with less than 3 characters returns empty</subtask>
        <subtask id="7.3">Manual test: verify results are grouped by type</subtask>
        <subtask id="7.4">Manual test: verify snippets contain highlighted matches</subtask>
        <subtask id="7.5">Verify search performance with explain analyze</subtask>
        <subtask id="7.6">Test edge cases: special characters, empty database, no matches</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Database indexes created on searchable fields: applications.company_name, applications.job_title, interview_notes.content, interview_questions.question_text, assessments.title</criterion>
    <criterion id="2">Search endpoint GET /api/search?q={query} queries across applications, interviews, interview_notes, assessments</criterion>
    <criterion id="3">Search uses PostgreSQL full-text search with proper indexing (GIN indexes, tsvector columns)</criterion>
    <criterion id="4">Results ranked by relevance (exact matches first, then partial)</criterion>
    <criterion id="5">Minimum 3 characters required to search</criterion>
    <criterion id="6">Results limited to 50 per entity type, grouped by type</criterion>
    <criterion id="7">Search queries execute within 1 second for datasets up to 1000 records</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-5.md</path>
        <title>Epic 5 Technical Specification</title>
        <section>Story 5.1: Global Search Backend</section>
        <snippet>PostgreSQL FTS with tsvector columns, GIN indexes, triggers for auto-update, /api/search endpoint. Results grouped by type, ranked by relevance.</snippet>
      </doc>
      <doc>
        <path>docs/research/postgresql-full-text-search.md</path>
        <title>PostgreSQL Full-Text Search Research</title>
        <section>Implementation Strategy</section>
        <snippet>Use websearch_to_tsquery for user input, ts_rank for scoring, ts_headline for snippets. GIN indexes on tsvector columns. Auto-update via triggers.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>ADR-003: PostgreSQL Full-Text Search for MVP</section>
        <snippet>Use PostgreSQL built-in full-text search with GIN indexes instead of Elasticsearch. Sufficient for MVP scale (1000+ records).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>API Contracts - Search Endpoints</section>
        <snippet>GET /api/search - Global search (query param: ?q=keyword). Returns grouped results by type.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/internal/repository/timeline_repository.go</path>
        <kind>repository</kind>
        <symbol>TimelineRepository</symbol>
        <lines>1-278</lines>
        <reason>Reference for UNION query pattern across multiple tables (interviews + assessments). Shows repository structure, pagination, and date calculations.</reason>
      </artifact>
      <artifact>
        <path>backend/internal/handlers/timeline_handler.go</path>
        <kind>handler</kind>
        <symbol>TimelineHandler</symbol>
        <lines>1-62</lines>
        <reason>Reference for handler pattern - query param validation, calling repository, returning response.</reason>
      </artifact>
      <artifact>
        <path>backend/internal/routes/timeline.go</path>
        <kind>routes</kind>
        <symbol>RegisterTimelineRoutes</symbol>
        <lines>1-20</lines>
        <reason>Reference for route registration pattern with auth middleware.</reason>
      </artifact>
      <artifact>
        <path>backend/internal/models/application.go</path>
        <kind>model</kind>
        <symbol>Application</symbol>
        <lines>16-37</lines>
        <reason>Application model - search will add search_vector column. Fields: JobID, Notes for search.</reason>
      </artifact>
      <artifact>
        <path>backend/internal/models/interview.go</path>
        <kind>model</kind>
        <symbol>Interview, InterviewNote, InterviewQuestion</symbol>
        <lines>1-100</lines>
        <reason>Interview models - search will query interview_notes.content and interview_questions.question_text.</reason>
      </artifact>
      <artifact>
        <path>backend/internal/models/assessment.go</path>
        <kind>model</kind>
        <symbol>Assessment</symbol>
        <lines>32-50</lines>
        <reason>Assessment model - search will add search_vector column. Fields: Title, Instructions.</reason>
      </artifact>
      <artifact>
        <path>backend/cmd/server/main.go</path>
        <kind>entrypoint</kind>
        <symbol>main</symbol>
        <lines>50-66</lines>
        <reason>Route registration location - add routes.RegisterSearchRoutes call here.</reason>
      </artifact>
      <artifact>
        <path>backend/migrations/000011_create_notification_system.up.sql</path>
        <kind>migration</kind>
        <symbol>latest migration</symbol>
        <reason>Reference for migration file naming. Next migration is 000012.</reason>
      </artifact>
    </code>
    <dependencies>
      <go>
        <package name="github.com/gin-gonic/gin" version="v1.10.1">Web framework</package>
        <package name="github.com/jmoiron/sqlx" version="v1.4.0">SQL extensions, used for db queries</package>
        <package name="github.com/google/uuid" version="v1.6.0">UUID handling</package>
        <package name="github.com/lib/pq" version="v1.10.9">PostgreSQL driver</package>
      </go>
      <database>
        <system>PostgreSQL 15+</system>
        <feature>Full-text search (tsvector, tsquery, GIN indexes)</feature>
        <feature>websearch_to_tsquery function</feature>
        <feature>ts_rank function</feature>
        <feature>ts_headline function</feature>
      </database>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="security">All search queries MUST filter by user_id from JWT token</constraint>
    <constraint type="security">Use parameterized queries only - no string concatenation for SQL</constraint>
    <constraint type="pattern">Follow handler/repository pattern from existing codebase</constraint>
    <constraint type="pattern">Use pkg/response for consistent API responses</constraint>
    <constraint type="pattern">Use pkg/errors for error conversion</constraint>
    <constraint type="performance">Search response time must be under 1 second for 1000+ records</constraint>
    <constraint type="performance">Use LIMIT in all queries (default 10, max 50 per type)</constraint>
    <constraint type="migration">Migration file must be numbered 000012 (after 000011_create_notification_system)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/search</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/search?q={query}&amp;limit={limit}</signature>
      <path>backend/internal/handlers/search_handler.go</path>
      <notes>q: required, min 3 chars. limit: optional, default 10, max 50 per type.</notes>
    </interface>
    <interface>
      <name>SearchRepository</name>
      <kind>repository interface</kind>
      <signature>Search(userID uuid.UUID, query string, limit int) (*GroupedSearchResponse, error)</signature>
      <path>backend/internal/repository/search_repository.go</path>
    </interface>
    <interface>
      <name>GroupedSearchResponse</name>
      <kind>response struct</kind>
      <signature>Applications, Interviews, Assessments, Notes []SearchResult; TotalCount int; Query string</signature>
      <path>backend/internal/models/search.go</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Follow existing test patterns in repository/*_test.go. Use testutil.NewTestDatabase for database tests. Manual testing required for full-text search functionality as it requires PostgreSQL.</standards>
    <locations>
      <location>backend/internal/repository/*_test.go</location>
      <location>backend/internal/handlers/*_test.go</location>
    </locations>
    <ideas>
      <idea ac="5">Test that query with less than 3 characters returns empty GroupedSearchResponse</idea>
      <idea ac="2,6">Test that search returns results grouped by type (applications, interviews, assessments, notes)</idea>
      <idea ac="4">Test that results are ordered by ts_rank score (highest first)</idea>
      <idea ac="6">Test that results are limited to specified limit per type</idea>
      <idea ac="2">Test that only user's own data is returned (security)</idea>
      <idea ac="3">Test that GIN indexes are used (EXPLAIN ANALYZE shows Index Scan)</idea>
      <idea ac="7">Performance test with 1000+ records completes in under 1 second</idea>
    </ideas>
  </tests>
</story-context>
