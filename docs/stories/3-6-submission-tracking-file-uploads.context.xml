<story-context id="3-6-submission-tracking-file-uploads" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>6</storyId>
    <title>Submission Tracking - File Uploads</title>
    <status>drafted</status>
    <generatedAt>2026-02-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-6-submission-tracking-file-uploads.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>job seeker</asA>
    <iWant>upload files as part of my assessment submission</iWant>
    <soThat>I can attach deliverables like PDFs, code archives, or presentation slides</soThat>
    <tasks>
      <task id="1" ac="3,6">Update file upload validation for assessment submissions
        <subtask>1.1 Add ASSESSMENT_MAX_FILE_SIZE = 10MB constant to frontend/src/lib/file-service.ts</subtask>
        <subtask>1.2 Add ASSESSMENT_ALLOWED_EXTENSIONS to include .zip (add application/zip, application/x-zip-compressed MIME types)</subtask>
        <subtask>1.3 Create validateAssessmentFile() function with 10MB limit and ZIP support</subtask>
        <subtask>1.4 Update backend presigned URL endpoint to accept submission_context: "assessment" and use 10MB limit</subtask>
      </task>
      <task id="2" ac="4">Extend file upload flow to support assessment submissions
        <subtask>2.1 Add assessmentSubmissionId parameter to getPresignedUploadUrl() and confirmUpload() in file-service.ts</subtask>
        <subtask>2.2 Update backend presigned-upload handler to accept assessment_submission_id (nullable)</subtask>
        <subtask>2.3 Update backend confirm-upload handler to link file to assessment_submission_id</subtask>
        <subtask>2.4 Add migration to add assessment_submission_id FK to files table if not exists</subtask>
      </task>
      <task id="3" ac="1">Add File Upload submission type to frontend service
        <subtask>3.1 Update SUBMISSION_TYPE_OPTIONS in assessment-service.ts to include file_upload</subtask>
        <subtask>3.2 Update CreateSubmissionRequest type to include optional file_id: string</subtask>
        <subtask>3.3 Add CreateFileSubmissionRequest type: { submission_type: 'file_upload'; file_id: string }</subtask>
      </task>
      <task id="4" ac="1,2,3,4">Update SubmissionFormModal to support file uploads
        <subtask>4.1 Add "File Upload" option to submission type Select</subtask>
        <subtask>4.2 Render FileUpload component when file_upload type is selected</subtask>
        <subtask>4.3 Pass special validation options to FileUpload for 10MB limit and ZIP support</subtask>
        <subtask>4.4 On file upload complete, store file_id in form state</subtask>
        <subtask>4.5 Submit file submission via API: { submission_type: 'file_upload', file_id: uploadedFileId }</subtask>
        <subtask>4.6 Handle two-step flow: file uploads immediately, then submission created on form save</subtask>
      </task>
      <task id="5" ac="5">Update SubmissionList to display file submissions
        <subtask>5.1 Add file submission rendering to submission-list.tsx</subtask>
        <subtask>5.2 Display: file icon (FileText or Archive for ZIP), file name as download link, file size, timestamp</subtask>
        <subtask>5.3 Fetch file details using file_id from submission record</subtask>
        <subtask>5.4 Download file using existing getFileDownloadUrl() from file-service.ts</subtask>
      </task>
      <task id="6" ac="8">Update backend to accept file_id in submission creation
        <subtask>6.1 Update CreateSubmissionRequest struct in assessment.go to include file_id (optional UUID)</subtask>
        <subtask>6.2 Add validation: when submission_type = file_upload, file_id is required</subtask>
        <subtask>6.3 Validate file exists and belongs to authenticated user before creating submission</subtask>
        <subtask>6.4 Store file_id in assessment_submissions record</subtask>
      </task>
      <task id="7" ac="7">Add delete file submission functionality
        <subtask>7.1 Add delete button to file submission display in SubmissionList</subtask>
        <subtask>7.2 Show confirmation dialog before deletion</subtask>
        <subtask>7.3 Call DELETE /api/assessment-submissions/:id endpoint (already exists)</subtask>
        <subtask>7.4 Optionally delete the associated file record</subtask>
      </task>
      <task id="8" ac="1-8">Testing and validation
        <subtask>8.1 Test "File Upload" option appears in submission type dropdown</subtask>
        <subtask>8.2 Test FileUpload component renders when file_upload type selected</subtask>
        <subtask>8.3 Test 10MB file uploads successfully (vs 5MB limit elsewhere)</subtask>
        <subtask>8.4 Test ZIP file uploads work</subtask>
        <subtask>8.5 Test file submission displays in list with download link</subtask>
        <subtask>8.6 Test file download works</subtask>
        <subtask>8.7 Test file submission deletion</subtask>
        <subtask>8.8 Test storage quota reflects uploaded assessment files</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">When adding a submission to an assessment, "File Upload" appears as a submission type option alongside GitHub and Notes</ac>
    <ac id="2">Selecting "File Upload" type shows the FileUpload component for selecting files</ac>
    <ac id="3">Allowed file types are PDF, ZIP, DOCX with a maximum size of 10MB for assessment submissions (vs 5MB for other uploads)</ac>
    <ac id="4">Uploaded files are stored via existing S3 presigned URL flow and linked to the submission record via file_id foreign key</ac>
    <ac id="5">Uploaded files appear in the SubmissionList component with: file icon, file name (clickable to download), file size, submitted timestamp</ac>
    <ac id="6">File uploads count toward the user's overall storage quota</ac>
    <ac id="7">User can delete a file submission with confirmation prompt</ac>
    <ac id="8">Creating a file_upload submission via API (POST /api/assessments/:id/submissions) accepts file_id and validates the file exists and belongs to user</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-3.md" title="Epic 3 Technical Specification" section="AC-3.6">
        File submission type allows uploading PDF, ZIP, DOCX up to 10MB. Uploads linked via file_id in submission. Files downloadable and deletable. Uploads count toward storage quota.
      </doc>
      <doc path="docs/tech-spec-epic-3.md" title="Epic 3 Technical Specification" section="Data Models - AssessmentSubmission">
        Defines assessment_submissions table with submission_type (github/file_upload/notes), file_id UUID FK to files table, and required fields.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="File Upload Security">
        File validation uses MIME type whitelist (PDF, DOCX, TXT). Size limits: 5MB default, 10MB for assessments. S3 bucket private, presigned URLs expire. Backend validates file ownership.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Backend â†” AWS S3">
        Pattern: Presigned URLs for direct client uploads. SDK: AWS SDK Go v2. Security: Bucket private, presigned URLs expire. Metadata tracked in files table.
      </doc>
    </docs>

    <code>
      <file path="frontend/src/lib/file-service.ts" kind="service" reason="Core file upload service with presigned URL flow, validation, and storage stats - needs 10MB assessment limit and ZIP support">
        <symbol>validateFile</symbol>
        <symbol>getPresignedUploadUrl</symbol>
        <symbol>uploadToS3</symbol>
        <symbol>confirmUpload</symbol>
        <symbol>getFileDownloadUrl</symbol>
        <symbol>MAX_FILE_SIZE</symbol>
        <symbol>ALLOWED_FILE_TYPES</symbol>
      </file>
      <file path="frontend/src/components/file-upload/file-upload.tsx" kind="component" reason="Reusable file upload component with drag-drop, progress, validation - needs assessment-specific validation options">
        <symbol>FileUpload</symbol>
        <symbol>FileUploadHandle</symbol>
        <symbol>FileUploadProps</symbol>
      </file>
      <file path="frontend/src/services/assessment-service.ts" kind="service" reason="Assessment API service - needs file_upload added to SUBMISSION_TYPE_OPTIONS and CreateSubmissionRequest updated">
        <symbol>SUBMISSION_TYPE_OPTIONS</symbol>
        <symbol>CreateSubmissionRequest</symbol>
        <symbol>createSubmission</symbol>
        <symbol>AssessmentSubmission</symbol>
        <symbol>SubmissionType</symbol>
      </file>
      <file path="frontend/src/components/submission-form/submission-form-modal.tsx" kind="component" reason="Modal for creating submissions - needs File Upload type option and FileUpload component integration">
        <symbol>SubmissionFormModal</symbol>
        <lines>34-70</lines>
      </file>
      <file path="frontend/src/components/submission-list/submission-list.tsx" kind="component" reason="Displays submissions - needs file_upload type rendering with download link">
        <symbol>SubmissionList</symbol>
        <symbol>SubmissionItem</symbol>
      </file>
      <file path="backend/internal/handlers/file.go" kind="handler" reason="File upload handlers - needs assessment submission context support and 10MB limit option">
        <symbol>GetPresignedUploadURL</symbol>
        <symbol>ConfirmUpload</symbol>
        <symbol>MaxFileSize</symbol>
        <symbol>allowedFileTypes</symbol>
        <symbol>PresignedUploadRequest</symbol>
        <symbol>ConfirmUploadRequest</symbol>
      </file>
      <file path="backend/internal/handlers/assessment.go" kind="handler" reason="Assessment submission handler - needs file_id field in CreateSubmissionRequest and ownership validation">
        <symbol>CreateSubmission</symbol>
        <symbol>CreateSubmissionRequest</symbol>
        <lines>293-351</lines>
      </file>
      <file path="backend/internal/models/assessment.go" kind="model" reason="AssessmentSubmission model - already has FileID field from migration">
        <symbol>AssessmentSubmission</symbol>
      </file>
      <file path="backend/internal/repository/file.go" kind="repository" reason="File repository - GetFileByID for ownership validation">
        <symbol>GetFileByID</symbol>
      </file>
    </code>

    <dependencies>
      <frontend>
        <package name="react-hook-form" version="^7.54.2" />
        <package name="zod" version="^3.24.2" />
        <package name="axios" version="^1.7.9" />
        <package name="sonner" version="^2.0.7" />
        <package name="date-fns" version="^4.1.0" />
        <package name="lucide-react" version="^0.452.0" />
        <package name="@radix-ui/react-dialog" version="^1.1.2" />
        <package name="@radix-ui/react-select" version="^2.2.6" />
        <package name="@radix-ui/react-alert-dialog" version="^1.1.15" />
      </frontend>
      <backend>
        <package name="github.com/gin-gonic/gin" version="v1.10.1" />
        <package name="github.com/google/uuid" version="v1.6.0" />
        <package name="github.com/jmoiron/sqlx" version="v1.4.0" />
        <package name="github.com/aws/aws-sdk-go-v2/service/s3" version="v1.95.0" />
      </backend>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface name="POST /api/assessments/:id/submissions" kind="REST endpoint">
      <signature>POST /api/assessments/:id/submissions
Request: { submission_type: 'github' | 'file_upload' | 'notes', github_url?: string, file_id?: string, notes?: string }
Response: { submission: AssessmentSubmission }</signature>
      <path>backend/internal/handlers/assessment.go:293-351</path>
    </interface>
    <interface name="POST /api/files/presigned-upload" kind="REST endpoint">
      <signature>POST /api/files/presigned-upload
Request: { file_name, file_type, file_size, application_id, interview_id?, assessment_submission_id? }
Response: { presigned_url, s3_key, expires_in }</signature>
      <path>backend/internal/handlers/file.go:96-140</path>
    </interface>
    <interface name="POST /api/files/confirm-upload" kind="REST endpoint">
      <signature>POST /api/files/confirm-upload
Request: { s3_key, file_name, file_type, file_size, application_id, interview_id?, assessment_submission_id? }
Response: FileRecord</signature>
      <path>backend/internal/handlers/file.go:142-189</path>
    </interface>
    <interface name="GET /api/files/:id" kind="REST endpoint">
      <signature>GET /api/files/:id
Response: { presigned_url, expires_in, file_name, file_size, file_type }</signature>
      <path>backend/internal/handlers/file.go:192-221</path>
    </interface>
    <interface name="DELETE /api/assessment-submissions/:id" kind="REST endpoint">
      <signature>DELETE /api/assessment-submissions/:id
Response: 204 No Content</signature>
      <path>backend/internal/routes/assessment.go</path>
    </interface>
    <interface name="validateFile" kind="function">
      <signature>validateFile(file: File): { valid: boolean; error?: string }</signature>
      <path>frontend/src/lib/file-service.ts:45-65</path>
    </interface>
    <interface name="getPresignedUploadUrl" kind="function">
      <signature>getPresignedUploadUrl(fileName, fileType, fileSize, applicationId, interviewId?, assessmentSubmissionId?): Promise&lt;PresignedUploadResponse&gt;</signature>
      <path>frontend/src/lib/file-service.ts:67-82</path>
    </interface>
    <interface name="getFileDownloadUrl" kind="function">
      <signature>getFileDownloadUrl(fileId: string): Promise&lt;FileDownloadResponse&gt;</signature>
      <path>frontend/src/lib/file-service.ts:153-158</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint source="Dev Notes">assessment_submissions table already has file_id UUID REFERENCES files(id) from Story 3.1 migration (000009)</constraint>
    <constraint source="Tech Spec AC-3.6">10MB limit specifically for assessment submissions, not global change to 5MB limit elsewhere</constraint>
    <constraint source="Architecture">File uploads create file record immediately, then submission links to it - handle orphaned files gracefully</constraint>
    <constraint source="Architecture">All queries scoped to authenticated user_id - backend validates file ownership before linking</constraint>
    <constraint source="Architecture">Use existing S3 presigned URL pattern - no direct AWS credentials on frontend</constraint>
    <constraint source="Story 3.5 Pattern">Use conditional rendering pattern established for github/notes types - add file_upload as third case</constraint>
    <constraint source="Architecture">MIME type whitelist validation - add application/zip and application/x-zip-compressed for assessment uploads</constraint>
    <constraint source="Story 3.5">Use toast.success() and toast.error() from sonner for user feedback</constraint>
    <constraint source="Story 3.5">Use response.Created() for 201 responses on submission creation</constraint>
  </constraints>

  <tests>
    <standards>
      Backend uses repository-level unit tests with testutil.CreateTestUser and testutil.SetupTestDB for database setup. Handler integration tests verify full HTTP request/response cycle. Frontend testing is manual for MVP with focus on user flows and edge cases.
    </standards>
    <locations>
      <location>backend/internal/repository/*_test.go</location>
      <location>backend/internal/handlers/*_test.go</location>
    </locations>
    <ideas>
      <idea ac="1">Verify "File Upload" option appears in submission type dropdown alongside GitHub and Notes</idea>
      <idea ac="2">Verify FileUpload component renders when file_upload type is selected, not for other types</idea>
      <idea ac="3">Test 10MB file upload succeeds for assessment submissions while 5MB limit still applies elsewhere</idea>
      <idea ac="3">Test ZIP file type is accepted for assessment submissions</idea>
      <idea ac="4">Verify file is stored via S3 presigned URL flow and file_id is linked to submission record</idea>
      <idea ac="5">Verify file submission displays with correct icon (Archive for ZIP), file name as download link, file size, timestamp</idea>
      <idea ac="6">Verify storage stats increase after assessment file upload</idea>
      <idea ac="7">Test delete button appears on file submission, confirmation dialog shows, deletion succeeds</idea>
      <idea ac="8">Test API validation: file_upload type requires file_id, file must exist and belong to user</idea>
      <idea ac="8">Test API rejects file_id that belongs to different user</idea>
    </ideas>
  </tests>
</story-context>
