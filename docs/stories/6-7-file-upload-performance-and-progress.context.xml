<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>7</storyId>
    <title>File Upload Performance and Progress</title>
    <status>drafted</status>
    <generatedAt>2026-02-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/6-7-file-upload-performance-and-progress.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>file uploads to show real-time progress with the ability to cancel or retry</iWant>
    <soThat>I have clear visibility into upload status and can recover from failures without re-selecting files</soThat>
    <tasks>
      <task id="1" acs="1,5,6">Create upload progress tracking hook
        <subtask id="1.1">Create `frontend/src/hooks/useFileUpload.ts` custom hook wrapping axios with `onUploadProgress`, tracking bytesUploaded, totalBytes, progress (0-100), status ('pending'|'uploading'|'completed'|'failed'|'cancelled'), error, estimatedTimeRemaining</subtask>
        <subtask id="1.2">Implement cancel via AbortController — expose cancel() that aborts request and sets status to 'cancelled'</subtask>
        <subtask id="1.3">Implement ETA calculation: track upload start time and bytes to compute speed, extrapolate remaining time; only show for files >1MB</subtask>
        <subtask id="1.4">Implement retry: expose retry() that re-attempts last failed upload using stored file reference</subtask>
        <subtask id="1.5">npm run build passes</subtask>
      </task>
      <task id="2" acs="1,6">Create progress bar UI component
        <subtask id="2.1">Create `frontend/src/components/file-upload/upload-progress.tsx` with shadcn/ui Progress, percentage text, ETA, speed, cancel button</subtask>
        <subtask id="2.2">Visual states: uploading (blue + %), completed (green + checkmark), failed (red + error + retry), cancelled (gray + label)</subtask>
        <subtask id="2.3">Accessible: role="progressbar", aria-valuenow, aria-valuemin="0", aria-valuemax="100", aria-label="File upload progress"</subtask>
        <subtask id="2.4">npm run build passes</subtask>
      </task>
      <task id="3" acs="1,3,4,5,7">Update FileUpload component with progress tracking
        <subtask id="3.1">Update file-upload.tsx to use useFileUpload hook; show UploadProgress during upload</subtask>
        <subtask id="3.2">Client-side file size validation before upload (5MB limit, immediate inline error)</subtask>
        <subtask id="3.3">Success toast + refresh file list without page reload</subtask>
        <subtask id="3.4">On failure: error in UploadProgress with retry button</subtask>
        <subtask id="3.5">On cancel: abort, reset UI, allow re-selection</subtask>
        <subtask id="3.6">npm run build passes</subtask>
      </task>
      <task id="4" acs="1,4,5">Update FileItem component with progress state
        <subtask id="4.1">Accept and display upload progress state for in-flight uploads (inline progress bar)</subtask>
        <subtask id="4.2">Cancel button during upload, retry button on failure</subtask>
        <subtask id="4.3">npm run build passes</subtask>
      </task>
      <task id="5" acs="1,3,4,5,7">Update assessment file upload with progress tracking
        <subtask id="5.1">Update assessment-file-upload.tsx to use useFileUpload hook and UploadProgress</subtask>
        <subtask id="5.2">Client-side file size validation for 10MB assessment limit</subtask>
        <subtask id="5.3">Progress bar, cancel, retry, success toast</subtask>
        <subtask id="5.4">npm run build passes</subtask>
      </task>
      <task id="6" acs="2">Backend upload timeout and streaming verification
        <subtask id="6.1">Verify backend streams to S3 without buffering — check file.go handler</subtask>
        <subtask id="6.2">Verify/set upload timeouts: 30s for 5MB, 60s for 10MB</subtask>
        <subtask id="6.3">Verify presigned URL flow returns proper error codes on timeout/failure</subtask>
        <subtask id="6.4">go build ./... passes</subtask>
      </task>
      <task id="7" acs="all">Testing and verification
        <subtask id="7.1">npm run build passes</subtask>
        <subtask id="7.2">go build ./... passes</subtask>
        <subtask id="7.3">Manual: upload 1MB file → progress bar shows % to 100%</subtask>
        <subtask id="7.4">Manual: upload 5MB file → completes within 10s, shows ETA</subtask>
        <subtask id="7.5">Manual: cancel in-progress upload → aborted, UI resets</subtask>
        <subtask id="7.6">Manual: simulate network failure → error with retry</subtask>
        <subtask id="7.7">Manual: click retry → re-attempts without re-selecting</subtask>
        <subtask id="7.8">Manual: file exceeding size limit → immediate client-side error</subtask>
        <subtask id="7.9">Manual: successful upload → toast shown, file in list</subtask>
        <subtask id="7.10">Manual: assessment file up to 10MB → progress + success</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Progress bar shows upload percentage — When uploading a file (resume, cover letter, interview prep, assessment submission), a progress bar displays 0-100% in real time (NFR-1.5)</ac>
    <ac id="2">5MB files upload within 10 seconds — Files up to 5MB complete within 10s on standard broadband (10 Mbps+) (NFR-1.5)</ac>
    <ac id="3">Upload completes with success message and file appears in list — Success toast shown and file immediately appears without page refresh</ac>
    <ac id="4">Upload failure shows clear error with retry option — On failure (network, server, timeout), specific error message and Retry button that re-attempts without re-selecting</ac>
    <ac id="5">User can cancel an in-progress upload — Cancel button visible during upload that aborts request, cleans up partial state, returns UI to pre-upload state</ac>
    <ac id="6">Large files show estimated time remaining — For files >1MB, display estimated time remaining (e.g., "~3s remaining") calculated from upload speed</ac>
    <ac id="7">Client-side file size check before upload — File size validated client-side before upload; files exceeding limit (5MB default, 10MB assessments) show immediate error without network request</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-6.md" title="Epic 6 Technical Specification" section="Story 6.7: File Upload Performance" snippet="Defines UploadProgress TypeScript interface, file upload with progress flow (presigned URL → S3 upload with onUploadProgress → confirm), and NFR-1.5 target of 5MB &lt; 10s." />
      <doc path="docs/tech-spec-epic-6.md" title="Epic 6 Technical Specification" section="Data Models and Contracts / File Upload Progress" snippet="Interface UploadProgress with fileId, fileName, progress (0-100), status enum, error, bytesUploaded, totalBytes, estimatedTimeRemaining." />
      <doc path="docs/tech-spec-epic-6.md" title="Epic 6 Technical Specification" section="Error Handling Strategy" snippet="Standardized error response schema with error codes (VALIDATION_ERROR, INTERNAL_ERROR, etc.). Toast for action errors, inline for validation errors." />
      <doc path="docs/architecture.md" title="Architecture Document" section="File Upload Pattern" snippet="Three-step flow: 1) Request presigned URL, 2) Upload directly to S3 with onUploadProgress, 3) Confirm upload. Presigned URLs tied to user_id." />
      <doc path="docs/architecture.md" title="Architecture Document" section="Frontend ↔ AWS S3" snippet="Direct upload using presigned URLs, no AWS credentials on frontend, progress tracking via axios onUploadProgress, backend confirmation endpoint after upload." />
      <doc path="docs/architecture.md" title="Architecture Document" section="File Upload Security" snippet="MIME type whitelist (PDF, DOCX, TXT, ZIP, PNG, JPG), size limits 5MB default / 10MB assessments, private S3 bucket with expiring presigned URLs." />
      <doc path="docs/architecture-frontend.md" title="Frontend Architecture" section="Technology Stack" snippet="Axios 1.7.9 HTTP client with request/response interceptors for JWT injection. shadcn/ui components with Radix UI primitives. React Hook Form + Zod for validation." />
      <doc path="docs/architecture-frontend.md" title="Frontend Architecture" section="Custom Hooks" snippet="Hooks directory at frontend/src/hooks/ with existing useAutoSave, useNotifications, use-mobile, use-breakpoint hooks." />
      <doc path="docs/accessibility-standards.md" title="Accessibility Standards" section="Loading States" snippet="Mark loading regions with aria-busy='true', aria-label. Buttons with loading state use disabled + aria-disabled + spinner with aria-hidden." />
      <doc path="docs/accessibility-standards.md" title="Accessibility Standards" section="Buttons / Accessible Names" snippet="Icon-only buttons need aria-label. Toggle buttons need aria-pressed. Disabled buttons use both disabled and aria-disabled attributes." />
      <doc path="docs/stories/6-5-error-handling-and-user-feedback.md" title="Story 6.5: Error Handling" section="Completion Notes" snippet="Centralized axios interceptor handles generic error toasts. Upload errors to S3 bypass backend interceptor entirely — must be handled locally in the upload hook." />
      <doc path="docs/stories/6-6-form-validation-and-user-input-quality.md" title="Story 6.6: Form Validation" section="Completion Notes" snippet="Zod schemas in frontend/src/lib/schemas/. validateFile() and validateAssessmentFile() already check type/size client-side. ARIA patterns (aria-invalid, aria-describedby, role=alert) established." />
    </docs>
    <code>
      <file path="frontend/src/components/file-upload/file-upload.tsx" kind="component" symbol="FileUpload" lines="1-318" reason="Primary file upload component to be enhanced with useFileUpload hook and UploadProgress. Currently uses uploadToS3 with basic progress callback, has cancel stub that only resets state without aborting." />
      <file path="frontend/src/components/file-upload/file-item.tsx" kind="component" symbol="FileItem" lines="1-145" reason="File list item component to be updated to show inline progress state for in-flight uploads. Currently only handles completed files (download/delete)." />
      <file path="frontend/src/components/submission-form/assessment-file-upload.tsx" kind="component" symbol="AssessmentFileUpload" lines="1-253" reason="Assessment file upload component to be updated with useFileUpload hook. Has similar structure to FileUpload but with 10MB limit and assessment-specific logic." />
      <file path="frontend/src/lib/file-service.ts" kind="service" symbol="uploadToS3, validateFile, validateAssessmentFile, getPresignedUploadUrl, confirmUpload" lines="1-219" reason="Core file service with presigned URL flow. uploadToS3 uses XMLHttpRequest with progress events. validateFile/validateAssessmentFile do client-side validation. The useFileUpload hook will wrap these functions." />
      <file path="frontend/src/lib/axios.ts" kind="config" symbol="api (axios instance)" lines="1-97" reason="Axios interceptor with retry logic and toast error handling. S3 uploads bypass this entirely (go directly to S3 presigned URLs). Error handling utilities imported from errors.ts." />
      <file path="frontend/src/lib/errors.ts" kind="utility" symbol="getErrorMessage, isValidationError, getFieldErrors" lines="1-90" reason="Error handling utilities. S3 upload errors are different from API errors — the useFileUpload hook should handle errors locally, not rely on these." />
      <file path="frontend/src/components/ui/progress.tsx" kind="ui-component" symbol="Progress" lines="1-33" reason="shadcn/ui Progress component built on @radix-ui/react-progress. Has indicatorClassName prop for customization. Will be used by the UploadProgress component." />
      <file path="frontend/src/hooks/useAutoSave.ts" kind="hook" symbol="useAutoSave" lines="1-108" reason="Existing hook pattern to follow for useFileUpload. Demonstrates convention: exports type for status, options interface, return interface, uses refs for stable references." />
      <file path="backend/internal/handlers/file.go" kind="handler" symbol="FileHandler, GetPresignedUploadURL, ConfirmUpload" lines="1-540" reason="Backend file handler. Uses presigned S3 URLs — frontend uploads directly to S3, backend doesn't buffer files. Validates file type/size, checks storage quota. Task 6 verifies this works correctly." />
    </code>
    <dependencies>
      <frontend>
        <dep name="axios" version="^1.7.9" relevance="HTTP client — uploadToS3 currently uses XHR but hook may use axios.put with onUploadProgress for S3 uploads" />
        <dep name="sonner" version="^2.0.7" relevance="Toast notifications for upload success/error" />
        <dep name="@radix-ui/react-progress" version="^1.1.8" relevance="Progress primitive used by shadcn/ui Progress component" />
        <dep name="lucide-react" version="^0.452.0" relevance="Icons for upload states (Upload, X, FileText, Loader2, CheckCircle)" />
        <dep name="react" version="^18" relevance="React hooks (useState, useRef, useCallback)" />
        <dep name="next" version="14.2.15" relevance="App Router, client components" />
        <dep name="tailwindcss" version="^4.1.10" relevance="Styling for progress bar states" />
        <dep name="zod" version="^3.24.2" relevance="File validation schemas" />
      </frontend>
      <backend>
        <dep name="github.com/aws/aws-sdk-go-v2" version="v1.41.0" relevance="S3 presigned URL generation for direct client uploads" />
        <dep name="github.com/aws/aws-sdk-go-v2/service/s3" version="v1.95.0" relevance="S3 operations (presigned PUT/GET, HeadObject, DeleteObject)" />
        <dep name="github.com/gin-gonic/gin" version="v1.10.1" relevance="HTTP handler framework" />
        <dep name="go" version="1.24.0" relevance="Go runtime" />
      </backend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">S3 presigned URL upload pattern: frontend uploads directly to S3 — onUploadProgress tracks the S3 PUT, not the backend presigned URL request</constraint>
    <constraint type="error-handling">S3 upload requests bypass the backend axios interceptor entirely. The useFileUpload hook must handle errors locally with inline display, not rely on centralized toast interceptor.</constraint>
    <constraint type="error-handling">Use sonner toast.success() for upload completion, consistent with all other CRUD operations</constraint>
    <constraint type="validation">validateFile() and validateAssessmentFile() in file-service.ts already handle client-side type/size validation — enhance UX but don't replace or duplicate</constraint>
    <constraint type="accessibility">Progress bar needs role="progressbar", aria-valuenow, aria-valuemin="0", aria-valuemax="100" per WCAG. Cancel/retry buttons need aria-label.</constraint>
    <constraint type="pattern">New hook in frontend/src/hooks/ — consistent with existing useAutoSave, useNotifications hooks</constraint>
    <constraint type="pattern">New component in frontend/src/components/file-upload/ — collocated with existing file upload components</constraint>
    <constraint type="performance">NFR-1.5: File upload 5MB &lt; 10 seconds on standard broadband (10 Mbps+)</constraint>
    <constraint type="backend">Backend presigned URL flow already streams to S3 without buffering. Task 6 is verification-only, no backend code changes expected unless issues found.</constraint>
    <constraint type="build">npm run build must pass after each task. go build ./... must pass after backend tasks.</constraint>
  </constraints>

  <interfaces>
    <interface name="File Presigned Upload" kind="REST endpoint" signature="POST /api/files/presigned-upload → { presigned_url, s3_key, expires_in }" path="backend/internal/handlers/file.go:110" />
    <interface name="File Confirm Upload" kind="REST endpoint" signature="POST /api/files/confirm-upload → FileResponse { id, file_name, file_type, file_size, s3_key, uploaded_at }" path="backend/internal/handlers/file.go:169" />
    <interface name="S3 Direct Upload" kind="HTTP PUT" signature="PUT {presigned_url} with Content-Type header and file body — progress tracked via XHR upload.onprogress or axios onUploadProgress" path="frontend/src/lib/file-service.ts:120" />
    <interface name="uploadToS3" kind="function" signature="uploadToS3(presignedUrl: string, file: File, onProgress?: (percent: number) => void): Promise&lt;void&gt;" path="frontend/src/lib/file-service.ts:120" />
    <interface name="validateFile" kind="function" signature="validateFile(file: File): { valid: boolean; error?: string }" path="frontend/src/lib/file-service.ts:54" />
    <interface name="validateAssessmentFile" kind="function" signature="validateAssessmentFile(file: File): { valid: boolean; error?: string }" path="frontend/src/lib/file-service.ts:76" />
    <interface name="FileUploadHandle" kind="component ref" signature="{ trigger: () => void }" path="frontend/src/components/file-upload/file-upload.tsx:25" />
    <interface name="UploadProgress (type)" kind="TypeScript interface" signature="{ fileId, fileName, progress: 0-100, status: 'pending'|'uploading'|'completed'|'failed'|'cancelled', error?, bytesUploaded, totalBytes, estimatedTimeRemaining? }" path="docs/tech-spec-epic-6.md (Data Models)" />
  </interfaces>

  <tests>
    <standards>Frontend uses npm run build as the primary verification (no test runner configured yet). Backend uses go build ./... and go test ./... with testify assertions. Manual testing via browser for upload UX. Accessibility verified with ARIA attributes in markup and keyboard testing.</standards>
    <locations>
      <location>frontend/ — npm run build (TypeScript compilation check)</location>
      <location>backend/ — go build ./... and go test ./...</location>
      <location>backend/internal/handlers/file_test.go — existing file handler tests</location>
    </locations>
    <ideas>
      <idea ac="1">Verify progress bar renders and updates from 0 to 100% during upload of a real file</idea>
      <idea ac="2">Upload a 5MB test file and verify completion within 10 seconds on broadband</idea>
      <idea ac="3">Verify success toast appears on completion and file shows in list without page refresh</idea>
      <idea ac="4">Simulate network failure (disconnect or throttle) during upload — verify error message and retry button appear</idea>
      <idea ac="4">Click retry after failure — verify upload re-attempts using stored file reference</idea>
      <idea ac="5">Click cancel during upload — verify request aborted, UI returns to idle state, can select new file</idea>
      <idea ac="6">Upload file >1MB — verify estimated time remaining displayed and updates as upload progresses</idea>
      <idea ac="7">Attempt to select file >5MB in FileUpload — verify immediate inline error before any network request</idea>
      <idea ac="7">Attempt to select file >10MB in AssessmentFileUpload — verify immediate inline error</idea>
      <idea ac="a11y">Verify progress bar has role="progressbar", aria-valuenow, aria-valuemin, aria-valuemax</idea>
      <idea ac="a11y">Verify cancel and retry buttons have accessible aria-label attributes</idea>
      <idea ac="a11y">Tab through upload flow — verify focus management on state transitions</idea>
    </ideas>
  </tests>
</story-context>
