<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>8</storyId>
    <title>File Uploads for Interview Prep Documents</title>
    <status>drafted</status>
    <generatedAt>2026-01-28</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-8-file-uploads-for-interview-prep-documents.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>job seeker</asA>
    <iWant>upload prep documents (PDFs, Word docs, TXT files) to an interview</iWant>
    <soThat>I can attach existing research, job descriptions, or study materials directly to my interview preparation</soThat>
    <tasks>
      <task id="1" ac="2,3,7">Extend File Service Functions for Interview Context
        <subtask id="1.1">Update getPresignedUploadUrl in frontend/src/lib/file-service.ts to accept optional interviewId parameter</subtask>
        <subtask id="1.2">Update confirmUpload in frontend/src/lib/file-service.ts to accept optional interviewId parameter</subtask>
        <subtask id="1.3">Pass interview_id to POST /api/files/presigned-upload and POST /api/files/confirm-upload when provided</subtask>
      </task>
      <task id="2" ac="1,4">Create DocumentsSection Component
        <subtask id="2.1">Create frontend/src/components/interview-detail/documents-section.tsx</subtask>
        <subtask id="2.2">Use CollapsibleSection pattern (matching InterviewersSection, QuestionsSection, NoteSection)</subtask>
        <subtask id="2.3">Display file count in section header (e.g., "Documents (3)")</subtask>
        <subtask id="2.4">Embed FileUpload component for upload capability</subtask>
        <subtask id="2.5">Embed FileList component for displaying uploaded files</subtask>
        <subtask id="2.6">Load files on mount using listFiles(applicationId, interviewId)</subtask>
        <subtask id="2.7">Handle upload completion by refreshing file list</subtask>
        <subtask id="2.8">Handle file deletion by removing from local state</subtask>
      </task>
      <task id="3" ac="2,3">Update FileUpload Component for Interview Support
        <subtask id="3.1">Add interviewId optional prop to FileUpload component</subtask>
        <subtask id="3.2">Pass interview_id to getPresignedUploadUrl when interviewId is provided</subtask>
        <subtask id="3.3">Pass interview_id to confirmUpload when interviewId is provided</subtask>
      </task>
      <task id="4" ac="2,3">Update file-service.ts for Interview ID Support
        <subtask id="4.1">Add optional interviewId parameter to getPresignedUploadUrl function</subtask>
        <subtask id="4.2">Include interview_id in presigned-upload request body when provided</subtask>
        <subtask id="4.3">Add optional interviewId parameter to confirmUpload function</subtask>
        <subtask id="4.4">Include interview_id in confirm-upload request body when provided</subtask>
      </task>
      <task id="5" ac="1">Integrate DocumentsSection into Interview Detail Page
        <subtask id="5.1">Import DocumentsSection in frontend/src/app/(app)/interviews/[id]/page.tsx</subtask>
        <subtask id="5.2">Add DocumentsSection to the interview detail page (after NoteSection)</subtask>
        <subtask id="5.3">Pass interviewId, applicationId (from data.interview.application_id), and files data</subtask>
        <subtask id="5.4">Export DocumentsSection from frontend/src/components/interview-detail/index.ts</subtask>
      </task>
      <task id="6" ac="4">Load Interview Files from API
        <subtask id="6.1">Call listFiles(applicationId, interviewId) in DocumentsSection on mount</subtask>
        <subtask id="6.2">Display loading skeleton while files load</subtask>
        <subtask id="6.3">Handle empty state (no files uploaded yet)</subtask>
      </task>
      <task id="7" ac="1-7">Manual Testing
        <subtask id="7.1">Test file upload via drag-and-drop on interview detail page</subtask>
        <subtask id="7.2">Test file upload via file picker click</subtask>
        <subtask id="7.3">Test upload progress bar displays correctly</subtask>
        <subtask id="7.4">Test file appears in list after upload</subtask>
        <subtask id="7.5">Test file download (opens presigned URL in new tab)</subtask>
        <subtask id="7.6">Test file deletion with confirmation dialog</subtask>
        <subtask id="7.7">Test rejection of invalid file types (e.g., .exe, .zip)</subtask>
        <subtask id="7.8">Test rejection of oversized files (>5MB)</subtask>
        <subtask id="7.9">Test storage quota enforcement (upload when near 100MB limit)</subtask>
        <subtask id="7.10">Test empty file rejection (0 bytes)</subtask>
        <subtask id="7.11">Test multiple file uploads to same interview</subtask>
        <subtask id="7.12">Test upload cancellation during progress</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" name="Upload Document Button">
      <given>I am viewing an interview detail page</given>
      <when>I look at the interview detail sections</when>
      <then>I see a "Documents" section (collapsible, consistent with Interviewers/Questions/Notes sections)</then>
      <and>Inside it I see an "Upload Document" area with drag-and-drop support</and>
      <and>The upload area shows accepted formats: PDF, DOCX, TXT up to 5MB</and>
    </criterion>
    <criterion id="AC-2" name="File Selection and Upload">
      <given>I am viewing an interview detail page</given>
      <when>I click the upload area or drag a file onto it</when>
      <then>A file picker opens (click) or the file is accepted (drag-drop)</then>
      <and>Only PDF, DOCX, TXT files up to 5MB are accepted</and>
      <and>Invalid files show an error message (wrong type or too large)</and>
    </criterion>
    <criterion id="AC-3" name="Upload Progress and Confirmation">
      <given>I am viewing an interview detail page</given>
      <when>I select a valid file</when>
      <then>I see a progress bar showing upload percentage</then>
      <and>After upload completes, the file is confirmed and linked to this interview</and>
      <and>A success toast notification appears</and>
      <and>The file appears in the documents list below the upload area</and>
    </criterion>
    <criterion id="AC-4" name="Document List Display">
      <given>I am viewing an interview detail page</given>
      <when>Uploaded files exist for this interview</when>
      <then>They appear as a list showing: file name, file size, and file type icon</then>
      <and>Each file has download and delete action buttons (visible on hover)</and>
      <and>Files are sorted by upload date (newest first)</and>
    </criterion>
    <criterion id="AC-5" name="File Download">
      <given>I am viewing an interview detail page</given>
      <when>I click the download button on a file</when>
      <then>The file downloads via a presigned S3 URL in a new tab</then>
    </criterion>
    <criterion id="AC-6" name="File Deletion with Confirmation">
      <given>I am viewing an interview detail page</given>
      <when>I click the delete button on a file</when>
      <then>A confirmation dialog appears asking "Delete this file?"</then>
      <and>Confirming deletes the file (soft delete)</and>
      <and>The file disappears from the list</and>
      <and>A success toast shows "File deleted"</and>
    </criterion>
    <criterion id="AC-7" name="Storage Quota Enforcement">
      <given>I am viewing an interview detail page</given>
      <when>I try to upload a file that would exceed my 100MB storage quota</when>
      <then>The upload is rejected with an error message about the storage limit</then>
      <and>I am not charged for the failed upload</and>
    </criterion>
    <edgeCases>
      <case>Empty files (0 bytes) are rejected before upload</case>
      <case>Upload can be cancelled during progress (cancel button visible)</case>
      <case>Network errors during upload show retry-friendly error message</case>
      <case>Files are linked to both the interview AND its parent application (application_id required by schema)</case>
      <case>Multiple files can be uploaded to the same interview (no limit on count)</case>
    </edgeCases>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Epic 1 Dependencies">
        Story 2.8 reuses S3 upload flow from Story 1.2/1.4. Files table already supports interview_id foreign key. File service extended for interview context.
      </doc>
      <doc path="docs/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Acceptance Criteria - AC-2.10">
        AC-2.10 defines file upload: Given viewing interview detail, When uploading prep document, Then file stored and linked to interview.
      </doc>
      <doc path="docs/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Traceability Mapping">
        AC-2.10 maps to Epic 1 File Storage infrastructure, using FileUpload component with interview_id. Integration test: upload file, verify linked to interview.
      </doc>
      <doc path="docs/PRD.md" title="Ditto Product Requirements Document" section="Flexible Preparation Area">
        Interview preparation includes file upload support for existing prep documents (PDFs, Word docs, etc.), along with rich text editor for notes and link storage for resources.
      </doc>
      <doc path="docs/PRD.md" title="Ditto Product Requirements Document" section="File Storage">
        Files stored on S3-compatible cloud storage. File size limits: 5MB per file, 100MB total per user (MVP). Supported formats: PDF, DOCX, TXT, PNG, JPG.
      </doc>
      <doc path="docs/PRD.md" title="Ditto Product Requirements Document" section="FR-1.7: Resume and Document Storage">
        User can upload files per application (PDF, DOCX, TXT). File size limit: 5MB per file. Total storage limit: 100MB per user. Files stored on S3-compatible infrastructure.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Decision Document" section="Tech Stack - File Storage">
        AWS S3 for file storage with AWS SDK Go v2 (backend) and presigned URLs (frontend). Chosen for low cost (~$0.02/month), reliability, scalability, zero maintenance.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Decision Document" section="File Upload Pattern">
        Three-phase upload: (1) request presigned URL from backend, (2) upload directly to S3 with progress tracking, (3) confirm upload to backend. Pattern already implemented in Epic 1.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Decision Document" section="Security - File Access">
        Presigned S3 URLs tied to user_id, backend validates ownership before generating download URLs.
      </doc>
      <doc path="docs/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="System Architecture - Backend">
        File infrastructure: handlers/file.go for upload/download/delete, services/s3_service.go for presigned URLs, repository/file_repository.go for CRUD, migration 000004 for files table.
      </doc>
      <doc path="docs/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="File Entity">
        Files table includes interview_id UUID REFERENCES interviews(id) ON DELETE CASCADE (nullable FK, marked "Future: Epic 2"). S3 key format: {user_id}/{uuid}.{extension}.
      </doc>
      <doc path="docs/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="Services and Modules">
        S3 Service generates presigned URLs (15 min expiry). File Repository handles CRUD. FileUpload Component handles client-side S3 uploads with progress. Storage Quota Service enforces per-user limits.
      </doc>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 2.8: File Uploads for Interview Prep Documents">
        Prerequisites: Story 1.2 (file storage infrastructure), Story 2.4 (interview detail view). Technical notes: reuse /api/files/upload endpoint with interview_id parameter, reuse FileUpload component, filter files by interview_id.
      </doc>
      <doc path="docs/design-system-principles.md" title="Design System Principles" section="Component Patterns">
        Collapsible sections used throughout interview detail. Consistent UI patterns for add/edit/delete actions with confirmation dialogs and toast notifications.
      </doc>
    </docs>

    <code>
      <!-- Backend: File Infrastructure (all REUSE AS-IS, no changes needed) -->
      <file path="backend/internal/handlers/file.go" kind="handler" symbol="FileHandler, GetPresignedUploadURL, ConfirmUpload, ListFiles, GetFile, DeleteFile" lines="29-358" reason="Complete file upload/download/delete API. Already supports interview_id in PresignedUploadRequest and ConfirmUploadRequest. ListFiles supports interview_id query param. No changes needed." />
      <file path="backend/internal/repository/file.go" kind="repository" symbol="FileRepository, CreateFile, GetUserFiles, SoftDeleteFile, GetUserStorageUsage, GetFileByID" lines="14-248" reason="File CRUD repository. GetUserFiles already filters by interviewID (lines 64-67). No changes needed." />
      <file path="backend/internal/models/file.go" kind="model" symbol="File" lines="9-30" reason="File model with InterviewID *uuid.UUID field and BelongsToInterview() method. No changes needed." />
      <file path="backend/internal/routes/file.go" kind="routes" symbol="RegisterFileRoutes" lines="17-56" reason="All file routes registered: GET /files, POST /files/presigned-upload, POST /files/confirm-upload, GET /files/:id, DELETE /files/:id. Rate limiting on uploads. No changes needed." />
      <file path="backend/internal/services/s3/service.go" kind="service" symbol="S3Service, GenerateS3Key, GeneratePresignedPutURL, GeneratePresignedGetURL, HeadObject, DeleteObject" lines="17-125" reason="S3 presigned URL generation and file operations. No changes needed." />
      <file path="backend/migrations/000004_create_file_system.up.sql" kind="migration" symbol="files table" lines="1-26" reason="Files table with interview_id FK, indexes on user_id/application_id/interview_id. Already applied." />

      <!-- Frontend: File Service (NEEDS MODIFICATION) -->
      <file path="frontend/src/lib/file-service.ts" kind="service" symbol="getPresignedUploadUrl, confirmUpload, uploadToS3, listFiles, deleteFile, getFileDownloadUrl, validateFile, FileRecord" lines="1-172" reason="Core file service. getPresignedUploadUrl (line 67) and confirmUpload (line 119) need optional interviewId param added. listFiles (line 136) already supports interviewId." />

      <!-- Frontend: File Upload Components (FileUpload NEEDS MODIFICATION, others REUSE AS-IS) -->
      <file path="frontend/src/components/file-upload/file-upload.tsx" kind="component" symbol="FileUpload" lines="28-282" reason="Drag-and-drop file upload with progress bar. Needs interviewId optional prop added and passed to getPresignedUploadUrl/confirmUpload calls (lines 80-97)." />
      <file path="frontend/src/components/file-upload/file-list.tsx" kind="component" symbol="FileList" lines="14-43" reason="Displays list of files with FileItem components. Reuse as-is. Props: files, onFileDeleted, emptyMessage." />
      <file path="frontend/src/components/file-upload/file-item.tsx" kind="component" symbol="FileItem" lines="34-145" reason="Individual file item with download/delete actions and confirmation dialog. Reuse as-is." />

      <!-- Frontend: Interview Detail Page (NEEDS MODIFICATION) -->
      <file path="frontend/src/app/(app)/interviews/[id]/page.tsx" kind="page" symbol="InterviewDetailPage" lines="72-342" reason="Interview detail page. Needs DocumentsSection added after NoteSection (line 254). Needs applicationId from data.interview.application_id passed to DocumentsSection." />
      <file path="frontend/src/components/interview-detail/index.ts" kind="barrel-export" symbol="exports" lines="1-5" reason="Barrel exports for interview detail components. Needs DocumentsSection export added." />

      <!-- Frontend: Pattern References -->
      <file path="frontend/src/components/interview-detail/collapsible-section.tsx" kind="component" symbol="CollapsibleSection" lines="26-81" reason="Wrapper component used by all interview detail sections. Props: title, children, defaultOpen, isEmpty, onAdd. Reuse as-is for DocumentsSection." />
      <file path="frontend/src/components/interview-detail/notes-section.tsx" kind="component" symbol="NoteSection" lines="38-164" reason="Pattern reference for interview detail section. Shows CollapsibleSection usage, data loading, and state management patterns." />
      <file path="frontend/src/components/interview-detail/interviewers-section.tsx" kind="component" symbol="InterviewersSection" lines="1-267" reason="Pattern reference for section with CRUD operations. Shows onUpdate callback pattern and local state management." />
      <file path="frontend/src/services/interview-service.ts" kind="service" symbol="InterviewWithDetails, getInterviewWithDetails" lines="112-156" reason="Interview service types. InterviewWithDetails interface does not currently include files array - DocumentsSection will load files independently via listFiles." />
    </code>

    <dependencies>
      <frontend ecosystem="node" manifest="frontend/package.json">
        <package name="next" version="14.2.15" reason="React framework" />
        <package name="react" version="^18" reason="UI library" />
        <package name="axios" version="^1.7.9" reason="HTTP client for API calls and S3 upload" />
        <package name="sonner" version="^2.0.7" reason="Toast notifications for upload success/error" />
        <package name="lucide-react" version="^0.452.0" reason="Icons (Upload, FileText, Download, Trash2, Loader2)" />
        <package name="zod" version="^3.24.2" reason="Schema validation" />
        <package name="@radix-ui/react-collapsible" version="^1.1.11" reason="CollapsibleSection component" />
        <package name="@radix-ui/react-dialog" version="^1.1.2" reason="Delete confirmation dialog" />
        <package name="@radix-ui/react-progress" version="^1.1.8" reason="Upload progress bar" />
        <package name="tailwind-merge" version="^2.5.3" reason="CSS class merging" />
        <package name="class-variance-authority" version="^0.7.0" reason="Component variants" />
      </frontend>
      <backend ecosystem="go" manifest="backend/go.mod">
        <package name="github.com/gin-gonic/gin" version="v1.10.1" reason="HTTP framework" />
        <package name="github.com/google/uuid" version="v1.6.0" reason="UUID generation for file IDs" />
        <package name="github.com/jmoiron/sqlx" version="v1.4.0" reason="Database queries" />
        <package name="github.com/aws/aws-sdk-go-v2" version="v1.41.0" reason="AWS S3 SDK for presigned URLs" />
        <package name="github.com/aws/aws-sdk-go-v2/service/s3" version="v1.95.0" reason="S3 service for file storage" />
      </backend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Reuse existing Epic 1 file storage infrastructure. No new backend endpoints or database migrations needed.</constraint>
    <constraint type="architecture">Three-phase upload pattern: (1) get presigned URL from backend, (2) upload directly to S3, (3) confirm upload to backend.</constraint>
    <constraint type="architecture">Files are linked to both interview_id AND application_id (application_id is required NOT NULL in the files table).</constraint>
    <constraint type="security">Presigned S3 URLs are time-limited (15 min). Backend validates file ownership via user_id before generating download URLs.</constraint>
    <constraint type="validation">File type validation: PDF, DOCX, TXT only. Max 5MB per file. Max 100MB total per user. Empty files (0 bytes) rejected.</constraint>
    <constraint type="pattern">Interview detail sections use CollapsibleSection wrapper component for consistent UI.</constraint>
    <constraint type="pattern">New components exported via barrel file at frontend/src/components/interview-detail/index.ts.</constraint>
    <constraint type="pattern">DocumentsSection manages its own file loading state independently (calls listFiles on mount) rather than relying on parent page data fetch.</constraint>
    <constraint type="pattern">Use sonner toast notifications for success/error feedback.</constraint>
    <constraint type="pattern">Soft delete for file deletion (sets deleted_at, backend also deletes from S3).</constraint>
  </constraints>

  <interfaces>
    <interface name="POST /api/files/presigned-upload" kind="REST endpoint" path="backend/internal/handlers/file.go">
      <signature>POST /api/files/presigned-upload { file_name: string, file_type: string, file_size: number, application_id: uuid, interview_id?: uuid } => { presigned_url: string, s3_key: string, expires_in: number }</signature>
    </interface>
    <interface name="POST /api/files/confirm-upload" kind="REST endpoint" path="backend/internal/handlers/file.go">
      <signature>POST /api/files/confirm-upload { s3_key: string, file_name: string, file_type: string, file_size: number, application_id: uuid, interview_id?: uuid } => FileRecord</signature>
    </interface>
    <interface name="GET /api/files" kind="REST endpoint" path="backend/internal/handlers/file.go">
      <signature>GET /api/files?application_id=uuid&amp;interview_id=uuid => FileRecord[]</signature>
    </interface>
    <interface name="GET /api/files/:id" kind="REST endpoint" path="backend/internal/handlers/file.go">
      <signature>GET /api/files/:id => { presigned_url: string, expires_in: number, file_name: string, file_size: number, file_type: string }</signature>
    </interface>
    <interface name="DELETE /api/files/:id" kind="REST endpoint" path="backend/internal/handlers/file.go">
      <signature>DELETE /api/files/:id => { message: "file deleted successfully" }</signature>
    </interface>
    <interface name="FileRecord" kind="TypeScript interface" path="frontend/src/lib/file-service.ts">
      <signature>interface FileRecord { id: string; file_name: string; file_type: string; file_size: number; s3_key: string; uploaded_at: string; created_at: string; updated_at: string; }</signature>
    </interface>
    <interface name="FileUpload" kind="React component" path="frontend/src/components/file-upload/file-upload.tsx">
      <signature>FileUpload({ applicationId?: string, interviewId?: string, onUploadComplete?: (file: FileRecord) => void, onFileSelect?: (file: File) => void, disabled?: boolean, label?: string, className?: string })</signature>
    </interface>
    <interface name="FileList" kind="React component" path="frontend/src/components/file-upload/file-list.tsx">
      <signature>FileList({ files: FileRecord[], onFileDeleted?: (fileId: string) => void, emptyMessage?: string, className?: string })</signature>
    </interface>
    <interface name="CollapsibleSection" kind="React component" path="frontend/src/components/interview-detail/collapsible-section.tsx">
      <signature>CollapsibleSection({ title: string, children: ReactNode, defaultOpen?: boolean, emptyState?: { label: string; onAction: () => void }, isEmpty?: boolean, onAdd?: () => void })</signature>
    </interface>
  </interfaces>

  <tests>
    <standards>Backend uses Go testing with testify assertions. Tests are co-located with source files (e.g., file_test.go next to file.go). Frontend does not currently have a test framework configured (no jest/vitest in package.json). Story 2.8 specifies manual testing only (Task 7) covering upload, download, delete, validation, quota enforcement, and error handling.</standards>
    <locations>
      <location>backend/internal/handlers/file_test.go</location>
      <location>backend/internal/repository/file_test.go</location>
    </locations>
    <ideas>
      <idea ac="AC-1">Verify DocumentsSection renders with CollapsibleSection, upload area, and file list</idea>
      <idea ac="AC-2">Verify FileUpload accepts PDF/DOCX/TXT up to 5MB and rejects invalid types and oversized files</idea>
      <idea ac="AC-3">Verify upload flow: presigned URL request includes interview_id, S3 upload shows progress, confirm includes interview_id, success toast appears</idea>
      <idea ac="AC-4">Verify file list displays file name, size, type icon, sorted by upload date descending</idea>
      <idea ac="AC-5">Verify download triggers presigned GET URL in new tab</idea>
      <idea ac="AC-6">Verify delete shows confirmation dialog, soft-deletes on confirm, removes from list, shows toast</idea>
      <idea ac="AC-7">Verify upload rejected when user storage exceeds 100MB quota with appropriate error message</idea>
      <idea ac="edge">Verify 0-byte files rejected, upload cancellation works, network errors show retry message</idea>
    </ideas>
  </tests>
</story-context>
