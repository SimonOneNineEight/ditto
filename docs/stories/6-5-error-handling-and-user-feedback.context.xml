<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>5</storyId>
    <title>Error Handling and User Feedback</title>
    <status>drafted</status>
    <generatedAt>2026-02-18</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/6-5-error-handling-and-user-feedback.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>clear feedback when things go wrong or succeed</iWant>
    <soThat>I always understand what's happening and can recover from errors</soThat>
    <tasks>
      <task id="1" acs="2,3,4">Standardize Backend Error Response Format
        <subtask id="1.1">Create or update backend/internal/models/error.go with ErrorResponse struct and error code constants</subtask>
        <subtask id="1.2">Add structured error logging to backend/internal/middleware/error.go</subtask>
        <subtask id="1.3">Audit all handlers to use standardized ErrorResponse with appropriate HTTP status codes</subtask>
        <subtask id="1.4">Ensure 500 errors return generic message - never expose internal details</subtask>
        <subtask id="1.5">go build ./... passes</subtask>
      </task>
      <task id="2" acs="2,3,8">Create Frontend Error Handling Utilities
        <subtask id="2.1">Create frontend/src/lib/errors.ts with ErrorResponse type and error code-to-message mapping</subtask>
        <subtask id="2.2">Create getErrorMessage(error: unknown): string utility</subtask>
        <subtask id="2.3">Enhance axios response interceptor in frontend/src/lib/axios.ts for toast errors, auth redirect, retry logic</subtask>
        <subtask id="2.4">npm run build passes</subtask>
      </task>
      <task id="3" acs="1">Add Success Toast Notifications Across All CRUD Operations
        <subtask id="3.1">Audit all create/update/delete operations; add toast.success() after successful operations</subtask>
        <subtask id="3.2">Application operations: create/update/delete toasts</subtask>
        <subtask id="3.3">Interview operations: create/update/delete toasts</subtask>
        <subtask id="3.4">Assessment operations: create/update/delete/status change toasts</subtask>
        <subtask id="3.5">Submission operations: create/update toasts</subtask>
        <subtask id="3.6">File operations: upload/delete toasts</subtask>
        <subtask id="3.7">Settings operations: update toast</subtask>
        <subtask id="3.8">Notification operations: mark all read toast</subtask>
        <subtask id="3.9">npm run build passes</subtask>
      </task>
      <task id="4" acs="2">Add React Error Boundary
        <subtask id="4.1">Create frontend/src/components/error-boundary.tsx with class component</subtask>
        <subtask id="4.2">Create fallback UI with error icon, heading, message, and refresh button</subtask>
        <subtask id="4.3">Wrap (app)/layout.tsx main content area with ErrorBoundary</subtask>
        <subtask id="4.4">npm run build passes</subtask>
      </task>
      <task id="5" acs="5,6">Add Loading States for Async Operations
        <subtask id="5.1">Audit all pages that fetch data on mount</subtask>
        <subtask id="5.2">Ensure each page shows Skeleton loading placeholder while data is loading</subtask>
        <subtask id="5.3">Ensure all form submit buttons show loading state and are disabled with aria-disabled</subtask>
        <subtask id="5.4">Ensure delete confirmation dialogs disable both buttons during delete</subtask>
        <subtask id="5.5">npm run build passes</subtask>
      </task>
      <task id="6" acs="7">Enhance Auto-Save Status Indicator
        <subtask id="6.1">Review existing useAutoSave hook and AutoSaveIndicator component</subtask>
        <subtask id="6.2">Ensure all auto-save indicators show three states: Saving/Saved/Failed with retry</subtask>
        <subtask id="6.3">Verify aria-live="polite" is present on all auto-save status elements</subtask>
        <subtask id="6.4">npm run build passes</subtask>
      </task>
      <task id="7" acs="8">Network Error Detection and Handling
        <subtask id="7.1">Add network status detection with online/offline event listeners</subtask>
        <subtask id="7.2">On offline: show persistent toast "Connection lost"</subtask>
        <subtask id="7.3">On reconnect: dismiss offline toast, show "Connection restored"</subtask>
        <subtask id="7.4">Add retry logic to axios interceptor: 3 retries with exponential backoff for network errors and 5xx</subtask>
        <subtask id="7.5">npm run build passes</subtask>
      </task>
      <task id="8" acs="all">Testing and Verification
        <subtask id="8.1">npm run build passes with no TypeScript errors</subtask>
        <subtask id="8.2">go build ./... passes with no Go compilation errors</subtask>
        <subtask id="8.3">Manual test: CRUD operations show success toasts</subtask>
        <subtask id="8.4">Manual test: errors show user-friendly messages</subtask>
        <subtask id="8.5">Manual test: network disconnect shows "Connection lost" toast</subtask>
        <subtask id="8.6">Manual test: loading skeletons appear on page navigation</subtask>
        <subtask id="8.7">Manual test: auto-save indicator states</subtask>
        <subtask id="8.8">Verify all toasts have appropriate accessibility</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Success toast shown for successful actions - All CRUD operations across applications, interviews, assessments, submissions, files, and settings display a success toast notification via sonner (NFR-4.4)</ac>
    <ac id="2">Error messages user-friendly - No stack traces, internal error codes, or raw server messages shown to users; all errors mapped to human-readable messages (NFR-3.3)</ac>
    <ac id="3">Errors include actionable guidance - Error messages provide next steps: "Try again", specific validation errors, or contextual recovery options (NFR-3.3)</ac>
    <ac id="4">All errors logged server-side with context - Backend logs all errors with structured format including user_id, endpoint, HTTP method, error code, and duration_ms; never logs sensitive data (NFR-3.3)</ac>
    <ac id="5">Loading states shown for operations >500ms - Async data fetching shows skeleton loaders or spinners; submit buttons show loading state during API calls (NFR-4.4)</ac>
    <ac id="6">Disabled state clear for unavailable actions - Buttons show visual disabled state with aria-disabled="true" during loading or when preconditions are unmet</ac>
    <ac id="7">Auto-save shows status progression - Rich text auto-save displays "Saving..." / "Saved" / "Save failed - retry" states with aria-live announcements for screen readers (NFR-3.4)</ac>
    <ac id="8">Network errors handled gracefully - Network failures show persistent toast; failed requests retry with exponential backoff</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-6.md" title="Epic 6 Technical Specification" section="Story 6.5, Data Models, Error Handling Strategy, Observability">
        Authoritative spec for story 6.5. Defines ErrorResponse schema (Go struct and TS type), error code constants, error-type-to-user-message mapping table, structured logging format, and new infrastructure components (LoadingSkeleton, ErrorBoundary).
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Consistency Rules - Error Handling, Logging Strategy">
        Defines standardized ErrorResponse struct with error/code/details fields, HTTP status code mapping (400-500), frontend toast vs inline error patterns, and structured logging rules (never log sensitive data).
      </doc>
      <doc path="docs/architecture-frontend.md" title="Frontend Architecture" section="API Client, Response Interceptor, Known Limitations">
        Documents current axios interceptor (only console.error), identifies missing error boundaries, toast notifications, and token refresh as known limitations to be addressed by this story.
      </doc>
      <doc path="docs/architecture-backend.md" title="Backend Architecture" section="Error Handling, Error System">
        Documents existing pkg/errors package with AppError struct, ErrorCode types, custom error constructors, and error middleware. Current system uses structured slog logging with user_id context.
      </doc>
      <doc path="docs/accessibility-standards.md" title="Accessibility Standards" section="Loading States, Live Regions, Buttons">
        Defines aria-busy="true" pattern for skeleton loaders, aria-disabled="true" for loading buttons, aria-live="polite" for toast announcements and dynamic content updates, focus-visible ring patterns.
      </doc>
      <doc path="docs/PRD.md" title="Product Requirements Document" section="NFR-3.3, NFR-3.4, NFR-4.4">
        Source non-functional requirements: NFR-3.3 (graceful error handling), NFR-3.4 (auto-save reliability), NFR-4.4 (visual feedback for user actions).
      </doc>
      <doc path="docs/epics.md" title="Epic Definitions" section="Epic 6, Story 6.5">
        Original story definition with technical notes on error handling, toast notifications, loading states, and auto-save status indicators.
      </doc>
      <doc path="docs/stories/6-4-accessibility-improvements-keyboard-navigation-and-screen-readers.md" title="Story 6.4 (predecessor)" section="Dev Agent Record, Completion Notes">
        Previous story established ARIA error patterns (aria-invalid, aria-describedby, role="alert"), verified sonner accessibility, added data-testid attributes, and established focus-visible patterns to maintain.
      </doc>
    </docs>

    <code>
      <file path="frontend/src/lib/axios.ts" kind="utility" symbol="api, interceptors" lines="1-69" reason="Central axios instance with request/response interceptors. Response interceptor currently only does console.error - needs enhancement for toast errors, auth redirect, and retry logic (Tasks 2, 7)."/>
      <file path="backend/pkg/errors/errors.go" kind="error-system" symbol="AppError, ErrorCode, New, Wrap" lines="1-182" reason="Core error type system. Already has ErrorCode constants and constructors. Story adds mapping to user-friendly messages and ensures consistent usage across all handlers (Task 1)."/>
      <file path="backend/pkg/errors/convert.go" kind="error-system" symbol="ConvertError, convertPQError, formatValidationErrors" lines="1-73" reason="Error conversion pipeline from Go errors to AppError. Handles sql.ErrNoRows, pq errors, validation errors. Used by middleware and handlers (Task 1)."/>
      <file path="backend/pkg/response/response.go" kind="response-helpers" symbol="ApiResponse, ErrorDetail, Error, BadRequest, Success, Created" lines="1-87" reason="HTTP response helpers. ErrorDetail struct already has error/code/details fields matching the spec. Handlers should use these consistently (Task 1)."/>
      <file path="backend/internal/middleware/error.go" kind="middleware" symbol="ErrorHandler, logError" lines="1-57" reason="Error middleware with structured slog logging including user_id, method, path, error_code, and category. Already well-structured - verify it covers all required fields (Task 1.2)."/>
      <file path="backend/internal/handlers/helpers.go" kind="handler-utility" symbol="HandleError, HandleErrorWithMessage" lines="1-30" reason="Handler helper functions for error responses. Used across handlers for consistent error handling (Task 1.3)."/>
      <file path="backend/internal/handlers/auth.go" kind="handler" symbol="AuthHandler" reason="Auth handler - needs audit for standardized error responses (Task 1.3)."/>
      <file path="backend/internal/handlers/application.go" kind="handler" symbol="ApplicationHandler" reason="Application handler - needs audit for standardized errors and is target for success toasts (Tasks 1.3, 3.2)."/>
      <file path="backend/internal/handlers/interview.go" kind="handler" symbol="InterviewHandler" reason="Interview handler - needs audit for standardized errors (Task 1.3)."/>
      <file path="backend/internal/handlers/interviewer.go" kind="handler" symbol="InterviewerHandler" reason="Interviewer handler - needs audit for standardized errors (Task 1.3)."/>
      <file path="backend/internal/handlers/interview_question.go" kind="handler" symbol="InterviewQuestionHandler" reason="Interview question handler - needs audit (Task 1.3)."/>
      <file path="backend/internal/handlers/interview_note.go" kind="handler" symbol="InterviewNoteHandler" reason="Interview note handler - needs audit (Task 1.3)."/>
      <file path="backend/internal/handlers/assessment.go" kind="handler" symbol="AssessmentHandler" reason="Assessment handler - needs audit (Task 1.3)."/>
      <file path="backend/internal/handlers/file.go" kind="handler" symbol="FileHandler" reason="File handler - needs audit (Task 1.3)."/>
      <file path="backend/internal/handlers/dashboard_handler.go" kind="handler" symbol="DashboardHandler" reason="Dashboard handler - needs audit (Task 1.3)."/>
      <file path="backend/internal/handlers/notification_handler.go" kind="handler" symbol="NotificationHandler" reason="Notification handler - needs audit (Task 1.3)."/>
      <file path="backend/internal/handlers/timeline_handler.go" kind="handler" symbol="TimelineHandler" reason="Timeline handler - needs audit (Task 1.3)."/>
      <file path="backend/internal/handlers/search_handler.go" kind="handler" symbol="SearchHandler" reason="Search handler - needs audit (Task 1.3)."/>
      <file path="backend/internal/handlers/export.go" kind="handler" symbol="ExportHandler" reason="Export handler - needs audit (Task 1.3)."/>
      <file path="frontend/src/hooks/useAutoSave.ts" kind="hook" symbol="useAutoSave, AutoSaveStatus" lines="1-107" reason="Auto-save hook with idle/saving/saved/error states and retry/flush. Already well-implemented - verify all consumers use it with AutoSaveIndicator (Task 6)."/>
      <file path="frontend/src/components/auto-save-indicator/AutoSaveIndicator.tsx" kind="component" symbol="AutoSaveIndicator" lines="1-69" reason="Auto-save status display with Saving/Saved/Failed states, aria-live='polite', and retry button. Already implements AC 7 pattern - verify all auto-save locations use it (Task 6)."/>
      <file path="frontend/src/app/(app)/layout.tsx" kind="layout" symbol="RootLayout" lines="1-73" reason="App layout with Toaster (sonner) already mounted. ErrorBoundary needs to wrap AuthGuard/LayoutWrapper children area (Task 4.3)."/>
      <file path="frontend/src/components/ui/skeleton.tsx" kind="ui-component" symbol="Skeleton" lines="1-13" reason="shadcn/ui Skeleton component already available for loading states (Task 5)."/>
      <file path="frontend/src/components/ui/sonner.tsx" kind="ui-component" symbol="Toaster" reason="Sonner toast component already configured in layout. Used for toast.success/error calls."/>
      <file path="frontend/src/components/interview-detail/self-assessment-card.tsx" kind="component" symbol="SelfAssessmentCard" reason="Uses useAutoSave + AutoSaveIndicator with aria-live. Reference implementation for auto-save pattern (Task 6)."/>
      <file path="frontend/src/components/interview-detail/notes-card.tsx" kind="component" symbol="NotesCard" reason="Uses useAutoSave for interview notes - verify AutoSaveIndicator integration (Task 6)."/>
      <file path="frontend/src/components/interview-detail/questions-card.tsx" kind="component" symbol="QuestionsCard" reason="Uses useAutoSave for questions - verify AutoSaveIndicator integration (Task 6)."/>
    </code>

    <dependencies>
      <ecosystem name="go" version="1.24.0">
        <package name="github.com/gin-gonic/gin" version="v1.10.1" purpose="Web framework - all handlers"/>
        <package name="github.com/go-playground/validator/v10" version="v10.26.0" purpose="Input validation"/>
        <package name="github.com/jmoiron/sqlx" version="v1.4.0" purpose="Database queries"/>
        <package name="github.com/lib/pq" version="v1.10.9" purpose="PostgreSQL driver"/>
        <package name="github.com/microcosm-cc/bluemonday" version="v1.0.27" purpose="HTML sanitization"/>
        <package name="github.com/golang-jwt/jwt/v5" version="v5.2.2" purpose="JWT handling"/>
        <package name="github.com/aws/aws-sdk-go-v2" version="v1.41.0" purpose="S3 file uploads"/>
        <package name="github.com/stretchr/testify" version="v1.10.0" purpose="Testing assertions"/>
        <package name="golang.org/x/crypto" version="v0.44.0" purpose="Password hashing"/>
      </ecosystem>
      <ecosystem name="node" version="18+">
        <package name="next" version="14.2.15" purpose="React framework"/>
        <package name="react" version="^18" purpose="UI library"/>
        <package name="typescript" version="^5" purpose="Type safety"/>
        <package name="axios" version="^1.7.9" purpose="HTTP client - interceptor enhancement target"/>
        <package name="sonner" version="^2.0.7" purpose="Toast notifications - central to this story"/>
        <package name="zod" version="^3.24.2" purpose="Schema validation"/>
        <package name="react-hook-form" version="^7.54.2" purpose="Form handling"/>
        <package name="@hookform/resolvers" version="^4.1.2" purpose="Zod integration"/>
        <package name="lucide-react" version="^0.452.0" purpose="Icons"/>
        <package name="tailwindcss" version="^4.1.10" purpose="CSS framework"/>
        <package name="next-auth" version="5.0.0-beta.29" purpose="Authentication"/>
        <package name="dompurify" version="^3.3.1" purpose="HTML sanitization"/>
        <package name="@tiptap/react" version="^3.17.1" purpose="Rich text editor"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture">Backend error responses must use ApiResponse wrapper: {success: false, error: {error: string, code: string, details?: string[]}}</constraint>
    <constraint source="architecture">HTTP status codes: 400 (validation), 401 (unauthorized), 403 (forbidden), 404 (not found), 500 (internal - generic message only)</constraint>
    <constraint source="architecture">Never log sensitive data (passwords, tokens, PII) in error logs</constraint>
    <constraint source="architecture">All error responses through pkg/response and pkg/errors packages - do not use ad-hoc gin.H{} for errors</constraint>
    <constraint source="architecture">Frontend uses centralized error handling via axios interceptor - components only need toast.success on success, errors handled by interceptor</constraint>
    <constraint source="accessibility">Sonner toasts include built-in aria-live support - no additional ARIA needed on toasts</constraint>
    <constraint source="accessibility">Auto-save indicators must have aria-live="polite" and aria-atomic="true"</constraint>
    <constraint source="accessibility">Loading buttons must use aria-disabled="true" and visual disabled state</constraint>
    <constraint source="accessibility">Skeleton loading regions should have aria-busy="true"</constraint>
    <constraint source="accessibility">New interactive elements (retry buttons, error recovery) must use focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2</constraint>
    <constraint source="accessibility">Add data-testid attributes to new error boundary and loading components</constraint>
    <constraint source="dev-notes">Backend already has structured slog logging in middleware/error.go with user_id, method, path, error_code - enhance rather than replace</constraint>
    <constraint source="dev-notes">Response interceptor currently does console.error only - enhance to show user-facing toasts and handle auth redirects (401 redirect already exists)</constraint>
    <constraint source="dev-notes">Backend handlers use mixed error formats - some use HandleError/HandleErrorWithMessage helpers, some use direct gin.H{} - standardize all to use helpers</constraint>
    <constraint source="dev-notes">Do NOT retry 4xx responses - only retry network errors and 5xx with exponential backoff</constraint>
    <constraint source="6.4-learnings">ARIA patterns established: aria-invalid, aria-describedby, role="alert" on error messages - maintain these patterns</constraint>
  </constraints>

  <interfaces>
    <interface name="ApiResponse" kind="response-wrapper" path="backend/pkg/response/response.go">
      type ApiResponse struct {
        Success  bool         `json:"success"`
        Data     interface{}  `json:"data,omitempty"`
        Warnings []string     `json:"warnings,omitempty"`
        Error    *ErrorDetail `json:"error,omitempty"`
      }
      type ErrorDetail struct {
        Message string   `json:"error"`
        Code    string   `json:"code"`
        Details []string `json:"details,omitempty"`
      }
    </interface>
    <interface name="AppError" kind="error-type" path="backend/pkg/errors/errors.go">
      type AppError struct {
        Code    ErrorCode `json:"code"`
        Message string    `json:"message"`
        Status  int       `json:"-"`
        Cause   error     `json:"-"`
        Details []string  `json:"-"`
      }
    </interface>
    <interface name="HandleError" kind="function" path="backend/internal/handlers/helpers.go">
      func HandleError(c *gin.Context, err error) - Converts error to AppError and sends response
      func HandleErrorWithMessage(c *gin.Context, err error, message string) - Same with custom message for unexpected errors
    </interface>
    <interface name="ErrorHandler middleware" kind="middleware" path="backend/internal/middleware/error.go">
      func ErrorHandler() gin.HandlerFunc - Catches gin errors, converts via ConvertError, logs with slog, sends response
    </interface>
    <interface name="axios interceptors" kind="http-interceptor" path="frontend/src/lib/axios.ts">
      Request: adds Bearer token, CSRF token for state-changing methods
      Response success: extracts CSRF token from headers
      Response error: console.error + 401 redirect to login + CSRF token reset on 403
    </interface>
    <interface name="useAutoSave" kind="react-hook" path="frontend/src/hooks/useAutoSave.ts">
      useAutoSave&lt;T&gt;(data: T, saveFunction: (data: T) =&gt; Promise&lt;void&gt;, options?) =&gt; { status: AutoSaveStatus, lastSaved: Date | null, retry: () =&gt; void, flush: () =&gt; void }
    </interface>
    <interface name="AutoSaveIndicator" kind="react-component" path="frontend/src/components/auto-save-indicator/AutoSaveIndicator.tsx">
      Props: { status: AutoSaveStatus, lastSaved?: Date | null, onRetry?: () =&gt; void, className?: string }
      Renders: Saving (spinner), Saved (check), Error (warning + retry button) with aria-live="polite"
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend uses Go testing with testify assertions. Tests live alongside source code with _test.go suffix. Repository tests use a test database (ditto_test) with automated setup/migration via internal/testutil. Handler tests exist for extract and file handlers. Frontend has no automated test infrastructure yet (no Jest/React Testing Library configured). Manual testing is the current approach for frontend. Story 6.9 will add formal testing infrastructure.
    </standards>
    <locations>
      backend/internal/repository/*_test.go
      backend/internal/handlers/*_test.go
      backend/internal/services/**/*_test.go
      backend/internal/middleware/*_test.go
    </locations>
    <ideas>
      <idea ac="1">Verify toast.success appears after each CRUD operation (applications, interviews, assessments, submissions, files, settings)</idea>
      <idea ac="2">Trigger 500 error and verify user sees "Something went wrong. Please try again." - no internal details</idea>
      <idea ac="3">Trigger validation error and verify field-specific messages appear; trigger 401 and verify "Session expired" message</idea>
      <idea ac="4">Check backend logs for structured format: user_id, endpoint, method, error_code, duration_ms on 4xx/5xx responses</idea>
      <idea ac="5">Navigate to data-fetching pages and verify Skeleton loaders appear during loading; verify submit buttons show spinner during API calls</idea>
      <idea ac="6">Verify buttons show opacity/cursor disabled state and aria-disabled="true" during loading</idea>
      <idea ac="7">Edit rich text content, verify "Saving..." appears, then "Saved"; disconnect network during save, verify "Save failed - retry" with retry button</idea>
      <idea ac="8">Disconnect network and verify persistent "Connection lost" toast; reconnect and verify "Connection restored" toast; verify failed requests retry (check network tab for 3 retries)</idea>
    </ideas>
  </tests>
</story-context>
