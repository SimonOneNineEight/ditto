<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>1</storyId>
    <title>Assessment Database Schema and API Foundation</title>
    <status>drafted</status>
    <generatedAt>2026-02-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-1-assessment-database-schema-and-api-foundation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>a robust database schema for technical assessments</iWant>
    <soThat>assessment data is properly structured and linked to applications</soThat>
    <tasks>
      <task id="1" ac="1,2,3,4">Create migration file 000009_create_assessment_system.up.sql
        <subtask>1.1: Create assessments table with all columns, constraints, and DEFAULT values</subtask>
        <subtask>1.2: Create assessment_submissions table with foreign keys to assessments and files</subtask>
        <subtask>1.3: Create all indexes (5 indexes: 2 partial on user_id/application_id, 2 standard on due_date/status, 1 partial on assessment_id)</subtask>
        <subtask>1.4: Verify UUID primary keys use gen_random_uuid() (matching existing pattern)</subtask>
      </task>
      <task id="2" ac="5">Create down migration 000009_create_assessment_system.down.sql
        <subtask>2.1: Drop assessment_submissions table first (depends on assessments)</subtask>
        <subtask>2.2: Drop assessments table</subtask>
        <subtask>2.3: Verify clean rollback does not affect other tables</subtask>
      </task>
      <task id="3" ac="6">Create Go models for assessment entities
        <subtask>3.1: Create backend/internal/models/assessment.go</subtask>
        <subtask>3.2: Define Assessment struct with UUID id, json/db tags, nullable fields as pointers</subtask>
        <subtask>3.3: Define AssessmentSubmission struct with proper tags</subtask>
        <subtask>3.4: Define type constants: AssessmentType (6 values), AssessmentStatus (4 values), SubmissionType (3 values)</subtask>
        <subtask>3.5: Follow existing pattern from models/interview.go (UUID PKs, json:"-" for DeletedAt)</subtask>
      </task>
      <task id="4" ac="7">Create assessment repository
        <subtask>4.1: Create backend/internal/repository/assessment.go</subtask>
        <subtask>4.2: Implement CreateAssessment (insert with required fields, return created record)</subtask>
        <subtask>4.3: Implement GetAssessmentByID (with user_id ownership check)</subtask>
        <subtask>4.4: Implement ListByApplicationID (sorted by due_date ascending, filtered by deleted_at IS NULL)</subtask>
        <subtask>4.5: Implement UpdateAssessment (partial field updates using dynamic query building)</subtask>
        <subtask>4.6: Implement SoftDeleteAssessment (set deleted_at, cascade to submissions)</subtask>
      </task>
      <task id="5" ac="7">Create assessment submission repository
        <subtask>5.1: Create backend/internal/repository/assessment_submission.go</subtask>
        <subtask>5.2: Implement CreateSubmission (insert with assessment_id, return created record)</subtask>
        <subtask>5.3: Implement ListByAssessmentID (sorted by submitted_at descending)</subtask>
        <subtask>5.4: Implement SoftDeleteSubmission (set deleted_at)</subtask>
      </task>
      <task id="6" ac="1,2,3,4,5">Run and verify migration
        <subtask>6.1: Run up migration against local database</subtask>
        <subtask>6.2: Verify both tables created with correct column types</subtask>
        <subtask>6.3: Verify indexes exist</subtask>
        <subtask>6.4: Verify foreign key constraints</subtask>
        <subtask>6.5: Run down migration and verify clean state</subtask>
        <subtask>6.6: Run up migration again to confirm re-runnability</subtask>
      </task>
      <task id="7" ac="6,7">Verify Go code compiles
        <subtask>7.1: Run go build ./... to verify models and repositories compile</subtask>
        <subtask>7.2: Verify no import cycles or type errors</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1" title="Assessments Table Creation">
      When migration 000009 runs, a new assessments table is created with fields: id (UUID PK), user_id (UUID FK to users), application_id (UUID FK to applications), assessment_type (VARCHAR(50) NOT NULL), title (VARCHAR(255) NOT NULL), due_date (DATE NOT NULL), status (VARCHAR(50) NOT NULL DEFAULT 'not_started'), instructions (TEXT), requirements (TEXT), created_at, updated_at, deleted_at (TIMESTAMP).
    </ac>
    <ac id="2" title="Assessment Submissions Table Creation">
      When migration 000009 runs, a new assessment_submissions table is created with: id (UUID PK), assessment_id (UUID FK to assessments NOT NULL), submission_type (VARCHAR(50) NOT NULL), github_url (VARCHAR(500)), file_id (UUID FK to files), notes (TEXT), submitted_at (TIMESTAMP DEFAULT NOW()), created_at (TIMESTAMP DEFAULT NOW()), deleted_at (TIMESTAMP).
    </ac>
    <ac id="3" title="Foreign Key Constraints">
      Assessment references valid application. Assessment submission references valid assessment. file_id references valid file (nullable FK).
    </ac>
    <ac id="4" title="Index Creation">
      Indexes created: idx_assessments_user_id (partial), idx_assessments_application_id (partial), idx_assessments_due_date, idx_assessments_status, idx_assessment_submissions_assessment_id (partial).
    </ac>
    <ac id="5" title="Down Migration">
      Down migration drops assessment_submissions first, then assessments. All indexes dropped. No impact on other tables.
    </ac>
    <ac id="6" title="Go Models Created">
      Assessment and AssessmentSubmission structs with json/db tags. Type constants for assessment_type (6 values), status (4 values), submission_type (3 values). DeletedAt uses json:"-".
    </ac>
    <ac id="7" title="Go Repositories Created">
      Assessment repository: Create, GetByID, ListByApplicationID, Update, SoftDelete. Submission repository: Create, ListByAssessmentID, SoftDelete. All queries scope to user_id. All filter deleted_at IS NULL.
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-3.md" title="Epic 3 Technical Specification" section="Data Models and Contracts" snippet="Authoritative SQL schema for assessments and assessment_submissions tables. Defines Go model structs with exact json/db tags, TypeScript types, and all enum values." />
      <doc path="docs/tech-spec-epic-3.md" title="Epic 3 Technical Specification" section="Acceptance Criteria (Authoritative)" snippet="AC-3.1: Running migration 000009 creates assessments and assessment_submissions tables with all specified columns, constraints, and indexes. Down migration drops tables cleanly." />
      <doc path="docs/tech-spec-epic-3.md" title="Epic 3 Technical Specification" section="Traceability Mapping" snippet="Maps AC-3.1 to migration 000009 with test idea: Run migration up/down, verify table structure, constraints, indexes." />
      <doc path="docs/tech-spec-epic-3.md" title="Epic 3 Technical Specification" section="Test Strategy Summary" snippet="Backend unit tests for repository layer: CreateAssessment, GetAssessmentByID, ListByApplicationID, UpdateAssessment, SoftDeleteAssessment with cascade, CreateSubmission for each type." />
      <doc path="docs/tech-spec-epic-3.md" title="Epic 3 Technical Specification" section="Risks, Assumptions, Open Questions" snippet="A1: Next migration is 000009 (latest is 000008). A2: Assessment detail accessed from application context. R3: Status transitions not enforced server-side for MVP." />
      <doc path="docs/epics.md" title="Epics" section="Story 3.1: Assessment Database Schema and API Foundation" snippet="Original story definition with acceptance criteria for assessments and assessment_submissions tables, FK constraints, indexes, enum values, and soft deletes." />
      <doc path="docs/architecture.md" title="Architecture Document" section="Database Schema (New Tables) - Migration 000006" snippet="Assessment system schema (renumbered to 000009). Defines assessments and assessment_submissions tables with columns, indexes, and entity relationships." />
      <doc path="docs/architecture.md" title="Architecture Document" section="Implementation Patterns" snippet="Naming conventions: snake_case DB columns, PascalCase Go structs, plural table names. API format: JSON request/response with ISO 8601 dates. Soft deletes with deleted_at." />
      <doc path="docs/architecture.md" title="Architecture Document" section="Consistency Rules" snippet="Validation on both client and server. Pagination offset-based. Auto-timestamps with DB triggers. Soft deletes cascade to related records." />
      <doc path="docs/database-schema.md" title="Database Schema Documentation" section="Overview" snippet="Existing schema uses UUID primary keys with gen_random_uuid(), soft deletes via deleted_at, auto-timestamps via update_timestamp() trigger function." />
      <doc path="docs/architecture-backend.md" title="Backend Architecture" section="Repository Pattern" snippet="Repository layer uses sqlx for queries, constructor injection of *sqlx.DB, error conversion via pkg/errors. Testing uses testutil fixtures." />
      <doc path="docs/stories/0-1-design-system-update.md" title="Previous Story (0.1)" section="Completion Notes" snippet="Production build clean. Button has forwardRef. No unresolved review items. Pre-existing ESLint warnings deferred to Epic 6." />
    </docs>

    <code>
      <!-- Models - Pattern References -->
      <artifact path="backend/internal/models/interview.go" kind="model" symbol="Interview, Interviewer, InterviewQuestion, InterviewNote, InterviewWithDetails" lines="1-94" reason="Pattern reference: UUID fields, json/db/validate tags, nullable pointer fields, type constants, IsDeleted() helper, embedded struct pattern" />
      <artifact path="backend/internal/models/file.go" kind="model" symbol="File" lines="9-30" reason="Pattern reference for file_id FK: File struct with nullable InterviewID, S3Key, status fields. assessment_submissions.file_id references this table" />

      <!-- Repositories - Pattern References -->
      <artifact path="backend/internal/repository/interview.go" kind="repository" symbol="InterviewRepository, NewInterviewRepository, CreateInterview, GetInterviewByID, UpdateInterview, SoftDeleteInterview, GetInterviewsByApplicationID" lines="1-335" reason="Primary pattern reference: constructor with *database.Database, uuid.New() for IDs, db.Exec with positional params, db.Get/db.Select, dynamic SET clauses, RowsAffected checks, errors.ConvertError" />
      <artifact path="backend/internal/repository/file.go" kind="repository" symbol="FileRepository, CreateFile, GetUserFiles, SoftDeleteFile, BeginTx, CreateFileTx" lines="1-248" reason="Pattern reference for soft delete, dynamic query building with fmt.Sprintf, transaction support, LEFT JOIN queries" />

      <!-- Handlers - Pattern Reference (for future Story 3.2 awareness) -->
      <artifact path="backend/internal/handlers/interview.go" kind="handler" symbol="InterviewHandler, CreateInterviewRequest, NewInterviewHandler, CreateInterview" lines="18-80" reason="Handler pattern: request struct with binding tags, handler struct with multiple repos, c.MustGet(user_id), ShouldBindJSON, HandleError" />

      <!-- Routes - Pattern Reference -->
      <artifact path="backend/internal/routes/interview.go" kind="routes" symbol="RegisterInterviewRoutes" lines="11-25" reason="Route registration pattern: apiGroup.Group, middleware.AuthMiddleware(), CRUD route setup" />

      <!-- Migration - Latest and Pattern References -->
      <artifact path="backend/migrations/000008_add_interviewers_updated_at.up.sql" kind="migration" symbol="ALTER TABLE, CREATE TRIGGER" lines="1-12" reason="Latest migration: column addition with DEFAULT, backfill, trigger creation referencing update_timestamp()" />
      <artifact path="backend/migrations/000004_create_file_system.up.sql" kind="migration" symbol="CREATE TABLE files" lines="1-25" reason="File system migration: UUID PK gen_random_uuid(), nullable FK to interviews, partial indexes WHERE deleted_at IS NULL, update trigger" />
      <artifact path="backend/migrations/000007_create_interview_system.up.sql" kind="migration" symbol="CREATE TABLE interviewers, interview_questions, interview_notes" lines="all" reason="Most comparable migration: creates multiple related tables with FKs, partial indexes, and constraints in one migration file" />

      <!-- Testing Utilities -->
      <artifact path="backend/internal/testutil/fixtures.go" kind="test-util" symbol="CreateTestUser, CreateTestCompany, CreateTestJob, CreateTestApplication, StringPtr, IntPtr" lines="12-118" reason="Test fixture helpers for creating dependencies. Will need CreateTestAssessment helper for assessment repository tests" />
      <artifact path="backend/internal/testutil/database.go" kind="test-util" symbol="TestDatabase, NewTestDatabase, RunMigrations, Truncate" lines="14-193" reason="Test DB setup: RunMigrations contains inline SQL for test schema. Must be updated to include assessment tables when tests are added" />

      <!-- Error Handling -->
      <artifact path="backend/pkg/errors/errors.go" kind="errors" symbol="AppError, ErrorCode, ErrorNotFound, ErrorBadRequest, New, Wrap, ConvertError" lines="1-119" reason="Error pattern: AppError with code/message/status, constructor New(), wrapper Wrap(), converter ConvertError() for sqlx errors" />

      <!-- Infrastructure -->
      <artifact path="backend/pkg/database/connection.go" kind="infrastructure" symbol="Database, NewConnection" lines="14-44" reason="Database struct wrapping *sqlx.DB, used by all repositories via constructor injection" />
      <artifact path="backend/internal/utils/state.go" kind="infrastructure" symbol="AppState, NewAppState" lines="8-26" reason="AppState holds DB reference, passed to handler constructors. Assessment handler will receive AppState" />
      <artifact path="backend/pkg/response/response.go" kind="infrastructure" symbol="Success, Error" lines="22-45" reason="Response helpers: Success(c, data) and Error(c, *AppError) for consistent API responses" />
      <artifact path="backend/cmd/server/main.go" kind="entrypoint" symbol="main, apiGroup" lines="48-58" reason="Route registration location: all RegisterXxxRoutes calls happen here. Assessment routes will be registered here in Story 3.2" />

      <!-- Existing Tests -->
      <artifact path="backend/internal/repository/file_test.go" kind="test" symbol="file repository tests" lines="all" reason="Test pattern reference: most comparable existing test file for repository testing patterns" />
    </code>

    <dependencies>
      <backend ecosystem="go" manifest="backend/go.mod">
        <dep name="go" version="1.24.0" />
        <dep name="github.com/gin-gonic/gin" version="v1.10.1" />
        <dep name="github.com/jmoiron/sqlx" version="v1.4.0" />
        <dep name="github.com/google/uuid" version="v1.6.0" />
        <dep name="github.com/lib/pq" version="v1.10.9" />
        <dep name="github.com/go-playground/validator/v10" version="v10.26.0" />
        <dep name="github.com/golang-migrate/migrate/v4" version="v4.18.3" />
        <dep name="github.com/golang-jwt/jwt/v5" version="v5.2.2" />
        <dep name="github.com/stretchr/testify" version="v1.10.0" />
        <dep name="golang.org/x/crypto" version="v0.44.0" />
      </backend>
      <frontend ecosystem="node" manifest="frontend/package.json">
        <dep name="next" version="14.2.15" />
        <dep name="react" version="^18" />
        <dep name="axios" version="^1.7.9" />
        <dep name="react-hook-form" version="^7.54.2" />
        <dep name="zod" version="^3.24.2" />
        <dep name="@hookform/resolvers" version="^4.1.2" />
        <dep name="date-fns" version="^4.1.0" />
        <dep name="tailwindcss" version="^4" note="devDependency" />
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Follow existing repository pattern: sqlx queries, UUID PKs with google/uuid, soft deletes with deleted_at IS NULL, dynamic query building for updates</constraint>
    <constraint type="pattern">Repository constructor takes *database.Database and accesses .DB field for *sqlx.DB</constraint>
    <constraint type="pattern">Use uuid.New() for ID generation in Create methods, time.Now() for timestamps</constraint>
    <constraint type="pattern">Error handling: return errors.ConvertError(err) for DB errors, errors.New() for business logic errors</constraint>
    <constraint type="pattern">Model structs: json/db tags on all fields, validate:"required" on required fields, pointer types (*string, *uuid.UUID, *time.Time) for nullable fields</constraint>
    <constraint type="pattern">DeletedAt field must use json:"-" tag to exclude from API responses</constraint>
    <constraint type="pattern">Migration naming: 000009_create_assessment_system.up.sql and .down.sql</constraint>
    <constraint type="pattern">UUID PKs with gen_random_uuid() DEFAULT (not application-generated)</constraint>
    <constraint type="pattern">Partial indexes use WHERE deleted_at IS NULL for query performance on active records</constraint>
    <constraint type="pattern">Auto-timestamps: created_at/updated_at DEFAULT NOW(), plus update_timestamp() trigger for updated_at</constraint>
    <constraint type="authorization">All repository queries must scope to user_id for data isolation</constraint>
    <constraint type="data-integrity">Soft delete cascade: deleting assessment must also soft-delete related submissions</constraint>
    <constraint type="scope">This story creates schema, models, and repositories ONLY. No handlers, routes, or frontend code (those are Story 3.2+)</constraint>
  </constraints>

  <interfaces>
    <interface name="AssessmentRepository" kind="go-repository" path="backend/internal/repository/assessment.go">
      <method signature="NewAssessmentRepository(database *database.Database) *AssessmentRepository" />
      <method signature="CreateAssessment(assessment *models.Assessment) (*models.Assessment, error)" />
      <method signature="GetAssessmentByID(id uuid.UUID, userID uuid.UUID) (*models.Assessment, error)" />
      <method signature="ListByApplicationID(applicationID uuid.UUID, userID uuid.UUID) ([]*models.Assessment, error)" />
      <method signature="UpdateAssessment(id uuid.UUID, userID uuid.UUID, updates map[string]interface{}) (*models.Assessment, error)" />
      <method signature="SoftDeleteAssessment(id uuid.UUID, userID uuid.UUID) error" />
    </interface>
    <interface name="AssessmentSubmissionRepository" kind="go-repository" path="backend/internal/repository/assessment_submission.go">
      <method signature="NewAssessmentSubmissionRepository(database *database.Database) *AssessmentSubmissionRepository" />
      <method signature="CreateSubmission(submission *models.AssessmentSubmission) (*models.AssessmentSubmission, error)" />
      <method signature="ListByAssessmentID(assessmentID uuid.UUID) ([]*models.AssessmentSubmission, error)" />
      <method signature="SoftDeleteSubmission(id uuid.UUID) error" />
    </interface>
    <interface name="Assessment SQL Schema" kind="sql-migration" path="backend/migrations/000009_create_assessment_system.up.sql">
      <table name="assessments" pk="id UUID" fks="user_id→users(id), application_id→applications(id)" />
      <table name="assessment_submissions" pk="id UUID" fks="assessment_id→assessments(id), file_id→files(id)" />
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend tests use Go's testing package with testify assertions. Repository tests use a dedicated test database (ditto_test) with testutil helpers for fixtures (CreateTestUser, CreateTestCompany, CreateTestJob, CreateTestApplication). Each test creates fresh data, runs operations, and validates results. Test DB setup in testutil/database.go includes inline migration SQL that must be updated when new tables are added. Soft delete behavior must be verified (deleted records excluded from queries). Use StringPtr/IntPtr helpers for nullable field test values.
    </standards>
    <locations>
      <location>backend/internal/repository/*_test.go</location>
      <location>backend/internal/testutil/</location>
    </locations>
    <ideas>
      <idea ac="1,2">Run migration 000009 up, verify assessments and assessment_submissions tables exist with correct columns via \d in psql</idea>
      <idea ac="3">Insert assessment with invalid application_id, verify FK constraint violation error</idea>
      <idea ac="3">Insert submission with invalid assessment_id, verify FK constraint violation error</idea>
      <idea ac="3">Insert submission with valid file_id from files table, verify FK succeeds</idea>
      <idea ac="3">Insert submission with NULL file_id, verify nullable FK allows it</idea>
      <idea ac="4">Verify all 5 indexes exist via \di in psql after migration</idea>
      <idea ac="5">Run down migration, verify both tables dropped, run up again to confirm re-runnability</idea>
      <idea ac="6">Verify Assessment struct fields match DB columns, type constants match expected enum values</idea>
      <idea ac="7">CreateAssessment with valid data returns assessment with generated UUID and timestamps</idea>
      <idea ac="7">GetAssessmentByID with wrong userID returns not found (ownership check)</idea>
      <idea ac="7">ListByApplicationID returns assessments sorted by due_date ascending</idea>
      <idea ac="7">UpdateAssessment with partial fields updates only specified fields</idea>
      <idea ac="7">SoftDeleteAssessment sets deleted_at on assessment and cascades to submissions</idea>
      <idea ac="7">CreateSubmission for each type (github, file_upload, notes) with appropriate fields</idea>
      <idea ac="7">ListByAssessmentID returns submissions sorted by submitted_at descending</idea>
      <idea ac="7">Soft-deleted assessments excluded from ListByApplicationID results</idea>
    </ideas>
  </tests>
</story-context>
