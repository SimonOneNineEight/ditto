<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>5</storyId>
    <title>In-App Notification Center with Configurable Preferences</title>
    <status>drafted</status>
    <generatedAt>2026-02-08</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-5-in-app-notification-center-with-configurable-preferences.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>job seeker</asA>
    <iWant>an in-app notification center showing all my reminders and alerts with configurable preferences</iWant>
    <soThat>I can see important notifications even if browser notifications are disabled and control what reminders I receive</soThat>
    <tasks>
      <task id="1" ac="1,2,3,6,7">Create Database Migration for Notification System - notifications and user_notification_preferences tables</task>
      <task id="2" ac="1,2,3,4,5">Backend Notification Repository - ListByUserID, GetUnreadCount, MarkAsRead, MarkAllAsRead, Create</task>
      <task id="3" ac="6">Backend Notification Preferences Repository - GetByUserID, Upsert</task>
      <task id="4" ac="1,2,3,4,5">Backend Notification Handler - GET/PATCH endpoints for notifications</task>
      <task id="5" ac="6">Backend Notification Preferences Handler - GET/PUT endpoints</task>
      <task id="6" ac="7">Backend Notification Service for Triggers - CreateInterviewReminder, CreateAssessmentReminder</task>
      <task id="7" ac="1,2,3,4,5,6">Frontend Notification Service - API client methods</task>
      <task id="8" ac="1,3,7">Frontend Notification Types - TypeScript interfaces</task>
      <task id="9" ac="1,2,3">Frontend useNotifications Hook - polling, state management</task>
      <task id="10" ac="1">Frontend NotificationBell Component - bell icon with badge (Z8MbU)</task>
      <task id="11" ac="2,3,4,5">Frontend NotificationDropdown Component - dropdown list (zb52V, 0SQx5)</task>
      <task id="12" ac="3,7">Frontend NotificationItem Component - item row (xNzjb, SxTEZ)</task>
      <task id="13" ac="6">Frontend NotificationPreferences Component - settings toggles (NGiup)</task>
      <task id="14" ac="1,2">Integrate NotificationCenter in Navbar</task>
      <task id="15" ac="6">Add NotificationPreferences to Settings Page</task>
      <task id="16" ac="1,2,3,4,5,6">Testing and Accessibility</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Notification bell icon with unread badge in navbar - A bell icon appears in the navbar showing a count badge when unread notifications exist</ac>
    <ac id="2">Notification dropdown opens on bell click - Clicking the bell opens a dropdown showing unread notifications</ac>
    <ac id="3">Notifications display type, message, timestamp, read status - Each notification shows icon, message, timestamp, and visual distinction for read/unread</ac>
    <ac id="4">Click notification marks as read and navigates - Clicking a notification marks it as read and navigates to the relevant page (interview or assessment)</ac>
    <ac id="5">Mark all as read with one click - A "Mark all as read" action clears all unread notifications</ac>
    <ac id="6">Configurable reminder preferences in settings - Users can configure reminder timing: interview reminders (24h, 1h before), assessment deadline reminders (3d, 1d, 1h before)</ac>
    <ac id="7">Notification types: interview reminders, assessment deadlines, system alerts - Support these three notification categories</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-4.md" title="Epic 4 Technical Specification" section="Story 4.5: In-App Notification Center">
        Defines notification types (interview_reminder_24h/1h, assessment_deadline_3d/1d/1h), backend API endpoints, database schema, and component architecture for NotificationCenter.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Database Schema - Migration 000008">
        Defines notifications table (id, user_id, type, title, message, link, read, created_at, deleted_at) and user_notification_preferences table with boolean columns for each preference type.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Project Structure">
        Maps notification components: notification_handler.go, notification_repository.go, notification_service.go (backend); NotificationCenter/, notificationService.ts, useNotifications.ts (frontend).
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="ADR-006">
        Decision to defer browser push notifications to post-MVP. In-app notifications only for MVP.
      </doc>
      <doc path="docs/epics.md" title="Epics Definition" section="Story 4.5">
        Original story definition with acceptance criteria for notification center with configurable preferences.
      </doc>
      <doc path="ditto-design.pen" title="Design File" section="Notification Components">
        Design specifications for: NotificationBell (Z8MbU), NotifItem/Unread (xNzjb), NotifItem/Read (SxTEZ), NotifDropdown/Populated (zb52V), NotifDropdown/Empty (0SQx5), NotificationsCard (NGiup), Dashboard-Notifications Open (dHzwS).
      </doc>
    </docs>
    <code>
      <file path="backend/internal/handlers/dashboard_handler.go" kind="handler" symbol="DashboardHandler" reason="Pattern reference for handler structure, error handling with HandleError(), response.Success() pattern">
        <lines>1-59</lines>
      </file>
      <file path="backend/internal/repository/dashboard_repository.go" kind="repository" symbol="DashboardRepository" reason="Pattern reference for repository with caching (5 min TTL), query structure, CountdownInfo calculation">
        <lines>1-335</lines>
      </file>
      <file path="backend/internal/routes/dashboard.go" kind="routes" symbol="RegisterDashboardRoutes" reason="Pattern for route registration with auth middleware">
        <lines>all</lines>
      </file>
      <file path="frontend/src/hooks/useAutoSave.ts" kind="hook" symbol="useAutoSave" reason="Pattern reference for custom hook with status state, refs, callbacks, and cleanup">
        <lines>1-98</lines>
      </file>
      <file path="frontend/src/hooks/index.ts" kind="barrel" symbol="exports" reason="Barrel export pattern for hooks - add useNotifications here">
        <lines>1-3</lines>
      </file>
      <file path="frontend/src/components/auto-save-indicator/AutoSaveIndicator.tsx" kind="component" symbol="AutoSaveIndicator" reason="Pattern for status indicator with icons, aria-live for accessibility, variant states">
        <lines>1-69</lines>
      </file>
      <file path="frontend/src/services/dashboard-service.ts" kind="service" symbol="getStats, getUpcomingItems" reason="Pattern for frontend service with api.get(), response.data?.data extraction, query params">
        <lines>1-35</lines>
      </file>
      <file path="frontend/src/types/upcoming.ts" kind="types" symbol="UpcomingItem, UpcomingFilterType" reason="Pattern for TypeScript interfaces matching backend response">
        <lines>all</lines>
      </file>
    </code>
    <dependencies>
      <ecosystem name="go-backend">
        <package name="github.com/gin-gonic/gin" version="latest">Web framework for handlers and routes</package>
        <package name="github.com/jmoiron/sqlx" version="latest">SQL extensions for repository queries</package>
        <package name="github.com/google/uuid" version="latest">UUID for user_id and notification id</package>
      </ecosystem>
      <ecosystem name="node-frontend">
        <package name="next" version="14.2.15">Next.js App Router framework</package>
        <package name="react" version="^18">React for components</package>
        <package name="axios" version="^1.7.9">HTTP client for API calls</package>
        <package name="lucide-react" version="^0.452.0">Icons: Bell, BellOff, Calendar, FileText, Check</package>
        <package name="@radix-ui/react-dropdown-menu" version="^2.1.2">Dropdown menu primitive for notification dropdown</package>
        <package name="@radix-ui/react-toggle" version="^1.1.10">Toggle primitive for preference switches</package>
        <package name="date-fns" version="^4.1.0">Date formatting for relative timestamps</package>
        <package name="sonner" version="^2.0.7">Toast notifications for save feedback</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture.md" type="pattern">Backend follows handler/repository/service pattern - handlers call repositories, services contain business logic for triggers</constraint>
    <constraint source="architecture.md" type="pattern">Frontend follows hooks in src/hooks/, services in src/services/, types in src/types/, components in flat directories under src/components/</constraint>
    <constraint source="architecture.md" type="api">REST API with JSON, JWT auth header, error format {error, code, details}</constraint>
    <constraint source="architecture.md" type="database">Soft deletes with deleted_at column, timestamps with created_at/updated_at</constraint>
    <constraint source="tech-spec-epic-4.md" type="performance">Notification polling interval: 60 seconds, API responses &lt;500ms</constraint>
    <constraint source="story-4-4" type="convention">Hooks go in frontend/src/hooks/ (not lib/hooks/)</constraint>
    <constraint source="story-4-4" type="convention">Component directories are flat: components/notification-center/ not components/shared/NotificationCenter/</constraint>
    <constraint source="story-4-4" type="convention">Create index.ts barrel exports for each component directory</constraint>
    <constraint source="design-file" type="styling">Use CSS variables: $--primary, $--card, $--border, $--muted-foreground, $--destructive</constraint>
  </constraints>

  <interfaces>
    <interface name="GET /api/notifications" kind="REST endpoint" path="backend/internal/handlers/notification_handler.go">
      <signature>GET /api/notifications?read=true|false&amp;limit=20</signature>
      <response>{ data: Notification[] }</response>
    </interface>
    <interface name="GET /api/notifications/count" kind="REST endpoint" path="backend/internal/handlers/notification_handler.go">
      <signature>GET /api/notifications/count</signature>
      <response>{ data: { unread_count: number } }</response>
    </interface>
    <interface name="PATCH /api/notifications/:id/read" kind="REST endpoint" path="backend/internal/handlers/notification_handler.go">
      <signature>PATCH /api/notifications/:id/read</signature>
      <response>{ data: Notification }</response>
    </interface>
    <interface name="PATCH /api/notifications/mark-all-read" kind="REST endpoint" path="backend/internal/handlers/notification_handler.go">
      <signature>PATCH /api/notifications/mark-all-read</signature>
      <response>{ data: { marked_count: number } }</response>
    </interface>
    <interface name="GET /api/users/notification-preferences" kind="REST endpoint" path="backend/internal/handlers/notification_handler.go">
      <signature>GET /api/users/notification-preferences</signature>
      <response>{ data: UserNotificationPreferences }</response>
    </interface>
    <interface name="PUT /api/users/notification-preferences" kind="REST endpoint" path="backend/internal/handlers/notification_handler.go">
      <signature>PUT /api/users/notification-preferences</signature>
      <request>{ interview_24h: bool, interview_1h: bool, assessment_3d: bool, assessment_1d: bool, assessment_1h: bool }</request>
      <response>{ data: UserNotificationPreferences }</response>
    </interface>
    <interface name="Notification" kind="TypeScript type" path="frontend/src/types/notification.ts">
      <signature>interface Notification { id: number; type: NotificationType; title: string; message: string; link?: string; read: boolean; created_at: string; }</signature>
    </interface>
    <interface name="NotificationType" kind="TypeScript union" path="frontend/src/types/notification.ts">
      <signature>type NotificationType = 'interview_reminder' | 'assessment_deadline' | 'system_alert'</signature>
    </interface>
    <interface name="NotificationPreferences" kind="TypeScript type" path="frontend/src/types/notification.ts">
      <signature>interface NotificationPreferences { interview_24h: boolean; interview_1h: boolean; assessment_3d: boolean; assessment_1d: boolean; assessment_1h: boolean; }</signature>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend: Unit tests for repository methods using testutil/database.go and testutil/fixtures.go. Integration tests for handlers with mock DB. Use table-driven tests with t.Run() for multiple scenarios. Frontend: No test framework configured yet - manual testing with accessibility verification. Use aria-live="polite" for dynamic content, aria-labels on interactive elements, keyboard navigation support.
    </standards>
    <locations>
      <location>backend/internal/repository/notification_repository_test.go</location>
      <location>backend/internal/repository/notification_preferences_repository_test.go</location>
      <location>backend/internal/handlers/notification_handler_test.go</location>
    </locations>
    <ideas>
      <idea ac="1">Test unread count returns correct value after creating notifications, marking as read</idea>
      <idea ac="2">Test ListByUserID with read filter returns only matching notifications</idea>
      <idea ac="3">Test notification item renders with correct icon based on type (calendar/file-text/bell)</idea>
      <idea ac="4">Test MarkAsRead updates notification and returns updated record</idea>
      <idea ac="5">Test MarkAllAsRead clears all unread for user, returns count</idea>
      <idea ac="6">Test preferences upsert creates new record or updates existing</idea>
      <idea ac="6">Test preferences API returns defaults (all true except assessment_1h) when no record exists</idea>
      <idea ac="7">Test notification service creates correct type based on interview vs assessment trigger</idea>
      <idea ac="a11y">Test notification dropdown is keyboard navigable (Tab, Enter, Escape)</idea>
      <idea ac="a11y">Test aria-live announces unread count changes</idea>
    </ideas>
  </tests>
</story-context>
