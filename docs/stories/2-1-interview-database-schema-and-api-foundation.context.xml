<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>Interview Database Schema and API Foundation</title>
    <status>drafted</status>
    <generatedAt>2026-01-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-1-interview-database-schema-and-api-foundation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>a robust database schema and API layer for interview management</iWant>
    <soThat>interview data is properly structured and accessible for all interview features</soThat>
    <tasks>
      <task id="1" name="Create migration file 000007_create_interview_system.up.sql">
        <subtasks>
          <subtask>1.1: Create interviews table with all required columns and constraints</subtask>
          <subtask>1.2: Create interviewers table with foreign key to interviews</subtask>
          <subtask>1.3: Create interview_questions table with order column</subtask>
          <subtask>1.4: Create interview_notes table with unique constraint on (interview_id, note_type)</subtask>
          <subtask>1.5: Create all partial indexes for query performance</subtask>
          <subtask>1.6: Create unique constraint for round_number per application</subtask>
        </subtasks>
        <note>Migration number is 000007, not 000005 - existing migrations go up to 000006</note>
      </task>
      <task id="2" name="Create down migration 000007_create_interview_system.down.sql">
        <subtasks>
          <subtask>2.1: Drop tables in correct dependency order</subtask>
          <subtask>2.2: Verify clean rollback</subtask>
        </subtasks>
      </task>
      <task id="3" name="Create Go models for interview entities">
        <subtasks>
          <subtask>3.1: Extend existing backend/internal/models/interview.go with new fields</subtask>
          <subtask>3.2: Add Interviewer, InterviewQuestion, InterviewNote structs</subtask>
          <subtask>3.3: Add InterviewWithDetails composite struct for API responses</subtask>
          <subtask>3.4: Add type constants for interview_type and note_type enums</subtask>
        </subtasks>
        <note>Existing Interview model needs to be replaced/extended - current model is minimal</note>
      </task>
      <task id="4" name="Create interview repository">
        <subtasks>
          <subtask>4.1: Create backend/internal/repository/interview.go</subtask>
          <subtask>4.2: Implement Create, GetByID, Update, Delete methods</subtask>
          <subtask>4.3: Implement GetByApplicationID (list interviews for an application)</subtask>
          <subtask>4.4: Implement GetByUserID with date filtering</subtask>
          <subtask>4.5: Implement GetNextRoundNumber (SELECT MAX(round_number) + 1)</subtask>
        </subtasks>
      </task>
      <task id="5" name="Create related entity repositories">
        <subtasks>
          <subtask>5.1: Create backend/internal/repository/interviewer.go</subtask>
          <subtask>5.2: Create backend/internal/repository/interview_question.go</subtask>
          <subtask>5.3: Create backend/internal/repository/interview_note.go</subtask>
          <subtask>5.4: Each with basic CRUD operations</subtask>
        </subtasks>
      </task>
      <task id="6" name="Run and verify migration">
        <subtasks>
          <subtask>6.1: Run up migration against local database</subtask>
          <subtask>6.2: Verify all tables created with correct structure</subtask>
          <subtask>6.3: Verify indexes exist with \di in psql</subtask>
          <subtask>6.4: Verify foreign key constraints work (insert test data)</subtask>
          <subtask>6.5: Run down migration and verify clean state</subtask>
          <subtask>6.6: Run up migration again to confirm idempotency</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" name="Interviews Table Creation">
      <given>the existing PostgreSQL database</given>
      <when>the migration runs</when>
      <then>a new interviews table is created with all specified fields including id, user_id, application_id, round_number, interview_type, scheduled_date, scheduled_time, duration_minutes, outcome, overall_feeling, went_well, could_improve, confidence_level, created_at, updated_at, deleted_at</then>
    </criterion>
    <criterion id="AC-2" name="Interviewers Table Creation">
      <when>the migration runs</when>
      <then>a new interviewers table is created with id, interview_id (FK), name, role, created_at, deleted_at</then>
    </criterion>
    <criterion id="AC-3" name="Interview Questions Table Creation">
      <when>the migration runs</when>
      <then>a new interview_questions table is created with id, interview_id (FK), question_text, answer_text, order, created_at, updated_at, deleted_at</then>
    </criterion>
    <criterion id="AC-4" name="Interview Notes Table Creation">
      <when>the migration runs</when>
      <then>a new interview_notes table is created with id, interview_id (FK), note_type enum, content (HTML), created_at, updated_at, deleted_at</then>
      <and>a unique constraint on (interview_id, note_type) prevents duplicate note types</and>
    </criterion>
    <criterion id="AC-5" name="Foreign Key Constraints">
      <when>an interview is deleted</when>
      <then>related interviewers, questions, and notes are cascade deleted</then>
      <and>interviews cannot reference non-existent applications or users</and>
    </criterion>
    <criterion id="AC-6" name="Index Creation">
      <when>the migration runs</when>
      <then>partial indexes are created on user_id, application_id, scheduled_date, and unique constraint on (application_id, round_number)</then>
    </criterion>
    <criterion id="AC-7" name="Down Migration">
      <when>the down migration runs</when>
      <then>all four tables are dropped in correct dependency order and all indexes are dropped</then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Data Models and Contracts</section>
        <snippet>Contains complete SQL CREATE TABLE statements for interviews, interviewers, interview_questions, and interview_notes tables with all indexes and constraints.</snippet>
      </doc>
      <doc>
        <path>docs/database-schema.md</path>
        <title>Database Schema Documentation</title>
        <section>Applications &amp; Interviews</section>
        <snippet>Documents existing interviews table structure and soft delete patterns. All tables use UUID primary keys and include audit timestamps.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-backend.md</path>
        <title>Backend Architecture</title>
        <section>Layered Architecture</section>
        <snippet>Describes Handler → Repository → Database pattern. Repository layer handles database queries with sqlx and transaction management.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.1</section>
        <snippet>Story acceptance criteria including table fields, foreign keys, indexes, and interview/note type enums.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>backend/migrations/000004_create_file_system.up.sql</path>
        <kind>migration</kind>
        <symbol>files table</symbol>
        <reason>Reference pattern for migration with partial indexes, soft deletes, and triggers. Files table already has interview_id FK.</reason>
      </artifact>
      <artifact>
        <path>backend/migrations/000006_fix_application_status_unique.up.sql</path>
        <kind>migration</kind>
        <symbol>latest migration</symbol>
        <reason>Confirms next migration number should be 000007.</reason>
      </artifact>
      <artifact>
        <path>backend/internal/models/interview.go</path>
        <kind>model</kind>
        <symbol>Interview struct</symbol>
        <lines>1-37</lines>
        <reason>Existing minimal Interview model that needs to be replaced with expanded version including round_number, user_id, self-assessment fields.</reason>
      </artifact>
      <artifact>
        <path>backend/internal/repository/file.go</path>
        <kind>repository</kind>
        <symbol>FileRepository</symbol>
        <lines>1-249</lines>
        <reason>Reference pattern for repository with CRUD, soft deletes, transactions, and sqlx usage.</reason>
      </artifact>
      <artifact>
        <path>backend/internal/models/application.go</path>
        <kind>model</kind>
        <symbol>Application struct</symbol>
        <reason>Applications table is parent of interviews - need to understand relationship.</reason>
      </artifact>
    </code>

    <dependencies>
      <go>
        <package name="github.com/gin-gonic/gin" version="1.10.1">HTTP framework</package>
        <package name="github.com/jmoiron/sqlx" version="1.4.0">SQL toolkit for database access</package>
        <package name="github.com/google/uuid" version="1.6.0">UUID generation</package>
        <package name="github.com/golang-migrate/migrate/v4" version="4.18.3">Database migrations</package>
        <package name="github.com/microcosm-cc/bluemonday" version="1.0.27">HTML sanitization (for notes content)</package>
        <package name="github.com/go-playground/validator/v10" version="10.26.0">Struct validation</package>
        <package name="github.com/lib/pq" version="1.10.9">PostgreSQL driver</package>
      </go>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture">Follow existing repository pattern: struct with *sqlx.DB, NewXxxRepository constructor</constraint>
    <constraint source="tech-spec">Use soft deletes (deleted_at column) for all new tables</constraint>
    <constraint source="tech-spec">Use partial indexes (WHERE deleted_at IS NULL) for query performance</constraint>
    <constraint source="tech-spec">Interview round_number auto-increments per application using GetNextRoundNumber query</constraint>
    <constraint source="tech-spec">Rich text content stored as sanitized HTML (max 50KB per note) - bluemonday for sanitization</constraint>
    <constraint source="database-schema">All tables use UUID primary keys with gen_random_uuid() default</constraint>
    <constraint source="database-schema">Include created_at, updated_at timestamps with update_timestamp() trigger</constraint>
    <constraint source="existing-code">Existing Interview model in models/interview.go will be replaced with expanded version</constraint>
    <constraint source="files-table">Files table already has interview_id column for file uploads per interview</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>InterviewRepository</name>
      <kind>Go struct interface</kind>
      <signature>
type InterviewRepository struct {
    db *sqlx.DB
}
func NewInterviewRepository(database *database.Database) *InterviewRepository
func (r *InterviewRepository) Create(interview *models.Interview) (*models.Interview, error)
func (r *InterviewRepository) GetByID(id, userID uuid.UUID) (*models.Interview, error)
func (r *InterviewRepository) Update(interview *models.Interview) error
func (r *InterviewRepository) SoftDelete(id, userID uuid.UUID) error
func (r *InterviewRepository) GetByApplicationID(applicationID uuid.UUID) ([]*models.Interview, error)
func (r *InterviewRepository) GetByUserID(userID uuid.UUID, fromDate, toDate *time.Time) ([]*models.Interview, error)
func (r *InterviewRepository) GetNextRoundNumber(applicationID uuid.UUID) (int, error)
      </signature>
      <path>backend/internal/repository/interview.go</path>
    </interface>
    <interface>
      <name>Interview model (expanded)</name>
      <kind>Go struct</kind>
      <signature>
type Interview struct {
    ID              uuid.UUID  `json:"id" db:"id"`
    UserID          uuid.UUID  `json:"user_id" db:"user_id"`
    ApplicationID   uuid.UUID  `json:"application_id" db:"application_id"`
    RoundNumber     int        `json:"round_number" db:"round_number"`
    InterviewType   string     `json:"interview_type" db:"interview_type"`
    ScheduledDate   time.Time  `json:"scheduled_date" db:"scheduled_date"`
    ScheduledTime   *string    `json:"scheduled_time,omitempty" db:"scheduled_time"`
    DurationMinutes *int       `json:"duration_minutes,omitempty" db:"duration_minutes"`
    Outcome         *string    `json:"outcome,omitempty" db:"outcome"`
    OverallFeeling  *string    `json:"overall_feeling,omitempty" db:"overall_feeling"`
    WentWell        *string    `json:"went_well,omitempty" db:"went_well"`
    CouldImprove    *string    `json:"could_improve,omitempty" db:"could_improve"`
    ConfidenceLevel *int       `json:"confidence_level,omitempty" db:"confidence_level"`
    CreatedAt       time.Time  `json:"created_at" db:"created_at"`
    UpdatedAt       time.Time  `json:"updated_at" db:"updated_at"`
    DeletedAt       *time.Time `json:"-" db:"deleted_at"`
}
      </signature>
      <path>backend/internal/models/interview.go</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend uses testify for assertions. Repository tests use a real PostgreSQL test database. Tests follow table-driven patterns with subtests. Each repository file has a corresponding _test.go file. Migration testing includes up, verify structure, down, and re-up for idempotency.
    </standards>
    <locations>
      <location>backend/internal/repository/*_test.go</location>
      <location>backend/migrations/*.sql (manual verification with psql)</location>
    </locations>
    <ideas>
      <idea ac="AC-1">Verify interviews table exists with all columns after migration</idea>
      <idea ac="AC-2">Verify interviewers table has FK constraint to interviews</idea>
      <idea ac="AC-3">Verify interview_questions order column allows reordering</idea>
      <idea ac="AC-4">Test unique constraint prevents duplicate (interview_id, note_type) pairs</idea>
      <idea ac="AC-5">Test CASCADE delete: deleting interview removes all child records</idea>
      <idea ac="AC-6">Verify partial indexes exist with \di command</idea>
      <idea ac="AC-7">Test down migration drops all tables without error</idea>
      <idea ac="AC-6">Test unique round_number constraint per application</idea>
      <idea>Test GetNextRoundNumber returns correct value for new and existing applications</idea>
      <idea>Test interview CRUD operations in repository</idea>
    </ideas>
  </tests>
</story-context>
