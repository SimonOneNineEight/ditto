<story-context id="6-1-performance-optimization-page-load-and-api-response-times" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>1</storyId>
    <title>Performance Optimization - Page Load and API Response Times</title>
    <status>ready-for-dev</status>
    <generatedAt>2026-02-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/6-1-performance-optimization-page-load-and-api-response-times.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>pages to load quickly and interactions to feel instant</iWant>
    <soThat>using ditto feels responsive and doesn't slow down my workflow</soThat>
    <tasks>
      <task id="1" name="Add Database Performance Indexes" acs="7">
        <subtask>1.1 Create migration 000013_add_performance_indexes.up.sql (note: 000012 exists for search vectors)</subtask>
        <subtask>1.2 Add composite index on applications(user_id, application_status_id) WHERE deleted_at IS NULL</subtask>
        <subtask>1.3 Add composite index on applications(user_id, applied_at DESC) WHERE deleted_at IS NULL</subtask>
        <subtask>1.4 Add index on assessments(user_id, due_date) WHERE deleted_at IS NULL</subtask>
        <subtask>1.5 Add index on notifications(user_id, read, created_at DESC) WHERE deleted_at IS NULL</subtask>
        <subtask>1.6 Add compound index on applications(user_id, application_status_id, applied_at) WHERE deleted_at IS NULL</subtask>
        <subtask>1.7 Add index on files(user_id, application_id, interview_id) WHERE deleted_at IS NULL</subtask>
        <subtask>1.8 Run migration and verify indexes created</subtask>
      </task>
      <task id="2" name="Optimize Slow Queries and Fix N+1 Issues" acs="3,4">
        <subtask>2.1 Add slow query logging (>500ms) to backend with context</subtask>
        <subtask>2.2 Audit existing repository methods for N+1 query patterns</subtask>
        <subtask>2.3 Optimize application list query with proper JOINs</subtask>
        <subtask>2.4 Optimize interview list query to include application data</subtask>
        <subtask>2.5 Verify dashboard stats query performance (already uses aggregation)</subtask>
        <subtask>2.6 Test and verify p90 &lt;500ms on local with representative data</subtask>
      </task>
      <task id="3" name="Verify Dashboard Stats Caching" acs="8">
        <subtask>3.1 EXISTING: Dashboard caching already implemented in dashboard_repository.go (5-min TTL)</subtask>
        <subtask>3.2 Verify cache invalidation is wired to application CRUD operations</subtask>
        <subtask>3.3 Add cache hit/miss logging if not present</subtask>
      </task>
      <task id="4" name="Enable Response Compression" acs="3,4">
        <subtask>4.1 Enable GZIP compression middleware in Gin</subtask>
        <subtask>4.2 Verify compression working with curl/dev tools</subtask>
      </task>
      <task id="5" name="Frontend Code Splitting and Lazy Loading" acs="1,2">
        <subtask>5.1 Verify Next.js route-based code splitting is working</subtask>
        <subtask>5.2 Implement dynamic import for TipTap rich text editor</subtask>
        <subtask>5.3 Lazy load calendar/date picker components</subtask>
        <subtask>5.4 Verify bundle sizes with Next.js build analyzer</subtask>
      </task>
      <task id="6" name="Add Loading Skeletons" acs="9">
        <subtask>6.1 Create LoadingSkeleton component variants in frontend/src/components/shared/LoadingSkeleton/</subtask>
        <subtask>6.2 Add skeleton variants: Card, Table row, List item, Dashboard stat</subtask>
        <subtask>6.3 Integrate skeleton loading states into Dashboard page (app/(app)/page.tsx)</subtask>
        <subtask>6.4 Integrate skeleton loading states into Application list page</subtask>
        <subtask>6.5 Integrate skeleton loading states into Interview/Assessment detail pages</subtask>
      </task>
      <task id="7" name="Optimize Images" acs="1,2">
        <subtask>7.1 Ensure all images use Next.js Image component</subtask>
        <subtask>7.2 Add lazy loading to non-critical images</subtask>
      </task>
      <task id="8" name="Performance Testing and Verification" acs="1,2,3,4,5,6">
        <subtask>8.1 Run Lighthouse audit on dashboard page, target score &gt;80</subtask>
        <subtask>8.2 Run Lighthouse audit on application list page</subtask>
        <subtask>8.3 Measure API response times with representative data</subtask>
        <subtask>8.4 Verify search response time &lt;1s with 1000 records</subtask>
        <subtask>8.5 Document final performance metrics</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Dashboard loads within 2 seconds on standard broadband (10 Mbps+)</ac>
    <ac id="2">Main views (application list, interview detail) load within 2 seconds</ac>
    <ac id="3">90% of API requests respond within 500ms</ac>
    <ac id="4">99% of API requests respond within 2 seconds</ac>
    <ac id="5">Search results return within 1 second</ac>
    <ac id="6">Initial page load with auth check completes within 3 seconds</ac>
    <ac id="7">Database indexes added on frequently queried columns (user_id, application_id, scheduled_date, status)</ac>
    <ac id="8">Dashboard stats cached for 5 minutes to reduce DB queries</ac>
    <ac id="9">Loading skeletons shown for operations >500ms</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-6.md" title="Tech Spec Epic 6" section="Story 6.1" snippet="Performance optimization story with detailed acceptance criteria, database index definitions, and frontend optimization strategies."/>
      <doc path="docs/architecture.md" title="Architecture Document" section="Performance Considerations" snippet="Target metrics: Dashboard <2s, API p90 <500ms, Search <1s. Strategies include indexes, caching, GZIP, code splitting."/>
      <doc path="docs/epics.md" title="Epic Definitions" section="Epic 6" snippet="Polish, Performance &amp; Production Readiness epic focusing on page load optimization, API response times, and loading states."/>
      <doc path="docs/PRD.md" title="PRD" section="NFR-1 Performance" snippet="Non-functional requirements for performance: NFR-1.1 page load times, NFR-1.2 API response times."/>
    </docs>
    <code>
      <file path="backend/internal/repository/dashboard_repository.go" kind="repository" symbol="DashboardRepository" lines="1-336" reason="CRITICAL: Already has 5-minute caching implemented. Contains statsCache map with TTL, GetStats with cache lookup, InvalidateCache method. AC8 is already partially complete."/>
      <file path="backend/internal/handlers/dashboard_handler.go" kind="handler" symbol="DashboardHandler" lines="1-60" reason="Dashboard API handlers that use DashboardRepository. GetStats and GetUpcomingItems endpoints."/>
      <file path="backend/cmd/server/main.go" kind="entrypoint" symbol="main" lines="1-90" reason="Server entry point where GZIP middleware needs to be added. Uses Gin with CORS middleware already configured."/>
      <file path="backend/internal/repository/application.go" kind="repository" symbol="ApplicationRepository" lines="1-100" reason="Application repository with filters. Check for N+1 patterns in list queries. Uses JOINs for related data."/>
      <file path="backend/internal/repository/interview.go" kind="repository" symbol="InterviewRepository" reason="Interview repository to audit for N+1 patterns and optimize list queries."/>
      <file path="backend/internal/repository/notification_repository.go" kind="repository" symbol="NotificationRepository" reason="Notification repository - queries need index on (user_id, read, created_at)."/>
      <file path="backend/migrations/000001_initial_schema.up.sql" kind="migration" lines="153-172" reason="Existing indexes: idx_applications_user_id, idx_interviews_user_id (partial), idx_interviews_scheduled_date (partial). New indexes should not duplicate."/>
      <file path="backend/migrations/000012_add_search_vectors.up.sql" kind="migration" lines="1-93" reason="Latest migration. New performance indexes should be 000013."/>
      <file path="frontend/src/app/(app)/page.tsx" kind="page" symbol="Dashboard" lines="1-182" reason="Dashboard page component. Uses loading state but shows 0 values instead of skeletons. StatCard needs skeleton support."/>
      <file path="frontend/src/app/(app)/applications/page.tsx" kind="page" symbol="ApplicationPageContent" lines="1-60" reason="Application list page. Uses loading state with Loader2 spinner. Needs skeleton loading states."/>
      <file path="frontend/src/components/ui/skeleton.tsx" kind="component" symbol="Skeleton" lines="1-14" reason="Base skeleton component from shadcn/ui. Use as base for LoadingSkeleton variants."/>
      <file path="frontend/src/components/stat-card.tsx" kind="component" symbol="StatCard" reason="Dashboard stat card component. Add skeleton loading support."/>
    </code>
    <dependencies>
      <backend>
        <package name="github.com/gin-gonic/gin" version="v1.10.1" note="Web framework - add compression middleware"/>
        <package name="github.com/gin-contrib/gzip" version="latest" note="NEED TO ADD: GZIP compression middleware for Gin"/>
        <package name="github.com/jmoiron/sqlx" version="v1.4.0" note="SQL library with named queries"/>
        <package name="github.com/lib/pq" version="v1.10.9" note="PostgreSQL driver"/>
      </backend>
      <frontend>
        <package name="next" version="14.2.15" note="Next.js with built-in code splitting"/>
        <package name="@tiptap/react" version="^3.17.1" note="Heavy component - needs dynamic import"/>
        <package name="react-day-picker" version="^9.13.0" note="Calendar - candidate for lazy loading"/>
        <package name="lucide-react" version="^0.452.0" note="Icons - already tree-shakeable"/>
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Follow existing Go handler/repository pattern. Services injected via constructor.</constraint>
    <constraint type="pattern">Use gin.H for JSON responses with pkg/response helpers.</constraint>
    <constraint type="pattern">PostgreSQL partial indexes with WHERE deleted_at IS NULL for soft delete compatibility.</constraint>
    <constraint type="pattern">Frontend: Client components with 'use client' directive. Use existing shadcn/ui components.</constraint>
    <constraint type="pattern">Dynamic imports with next/dynamic for code splitting. SSR false for client-only components.</constraint>
    <constraint type="naming">Migration files: 000013_add_performance_indexes.up.sql / .down.sql</constraint>
    <constraint type="naming">Indexes: idx_{table}_{columns} pattern (e.g., idx_applications_user_status)</constraint>
    <constraint type="architecture">Dashboard caching already exists - verify invalidation, don't recreate.</constraint>
    <constraint type="architecture">Some indexes already exist (interviews). Check 000001 schema before adding duplicates.</constraint>
  </constraints>

  <interfaces>
    <interface name="GET /api/dashboard/stats" kind="REST endpoint" signature="GET /api/dashboard/stats -> { total_applications, active_applications, interview_count, offer_count, status_counts, updated_at }" path="backend/internal/handlers/dashboard_handler.go"/>
    <interface name="GET /api/dashboard/upcoming" kind="REST endpoint" signature="GET /api/dashboard/upcoming?limit=N&amp;type=all|interviews|assessments -> []UpcomingItem" path="backend/internal/handlers/dashboard_handler.go"/>
    <interface name="DashboardRepository.GetStats" kind="function signature" signature="func (r *DashboardRepository) GetStats(userID uuid.UUID) (*DashboardStats, error)" path="backend/internal/repository/dashboard_repository.go"/>
    <interface name="DashboardRepository.InvalidateCache" kind="function signature" signature="func (r *DashboardRepository) InvalidateCache(userID uuid.UUID)" path="backend/internal/repository/dashboard_repository.go"/>
    <interface name="Skeleton" kind="React component" signature="function Skeleton({ className, ...props }: React.ComponentProps&lt;'div'&gt;)" path="frontend/src/components/ui/skeleton.tsx"/>
  </interfaces>

  <tests>
    <standards>Backend: Go testing with testify. Repository tests use test database with migrations. Handler tests use httptest. Frontend: Not specified in codebase - focus on manual Lighthouse audits and performance measurement.</standards>
    <locations>
      <location>backend/internal/repository/*_test.go</location>
      <location>backend/internal/handlers/*_test.go</location>
    </locations>
    <ideas>
      <idea ac="3,4">Benchmark tests for API endpoints measuring response time percentiles</idea>
      <idea ac="7">Migration test to verify indexes exist after running up migration</idea>
      <idea ac="8">Unit test for cache hit/miss behavior in DashboardRepository</idea>
      <idea ac="1,2">Lighthouse CI integration for automated performance scoring (stretch)</idea>
      <idea ac="5">Search performance test with 1000+ records</idea>
    </ideas>
  </tests>

  <importantDiscoveries>
    <discovery severity="high">Dashboard caching (AC8) is ALREADY IMPLEMENTED in dashboard_repository.go. The 5-minute TTL cache exists with GetStats checking cache before DB query. InvalidateCache method exists. Story task should verify invalidation is wired correctly, not re-implement.</discovery>
    <discovery severity="medium">Migration numbering: Latest is 000012 (search vectors). New performance indexes should be 000013, not 000011 as stated in story.</discovery>
    <discovery severity="medium">Some indexes already exist: idx_interviews_user_id, idx_interviews_scheduled_date, idx_applications_user_id. Review 000001 schema to avoid duplicates.</discovery>
    <discovery severity="low">gin-contrib/gzip package may need to be added to go.mod for compression middleware.</discovery>
  </importantDiscoveries>
</story-context>
